window.addEventListener('DOMContentLoaded',function(){if(typeof window.videoData==='undefined'){console.error('videoData未加载，请确保videoData.js在video.js之前加载');return}let dp=null;let currentCategory='knxy';let folderHistory=[];function disableVideoContextMenu(){document.addEventListener('contextmenu',function(e){if(e.target.tagName==='VIDEO'||e.target.closest('.dplayer')){e.preventDefault();return false}})}function initCategories(){const container=document.getElementById('categories-container');container.innerHTML='';window.categories.forEach(cat=>{const btn=document.createElement('button');btn.className='category-btn';if(cat.id===currentCategory)btn.classList.add('active');btn.dataset.category=cat.id;btn.innerHTML=`<i class="${cat.icon}"></i> ${cat.name}`;container.appendChild(btn)})}function loadCategoryVideos(categoryId,isFolder=false){const videosList=document.getElementById('videos-list');videosList.innerHTML='';if(isFolder){const backItem=document.createElement('div');backItem.className='video-item back-folder';backItem.innerHTML=`<div class="video-thumb"><i class="fas fa-arrow-left"></i></div><div class="video-info"><div class="video-title">返回上一级</div></div>`;videosList.appendChild(backItem)}const data=window.videoData[categoryId];if(!data)return;data.forEach(video=>{const item=document.createElement('div');if(video.isFolder){item.className='video-item folder-item';item.dataset.folderId=video.id;item.innerHTML=`<div class="video-thumb"><i class="fas fa-folder"></i></div><div class="video-info"><div class="video-title">${video.title}</div><div class="video-desc">${video.desc||'文件夹'}</div></div>`}else{item.className='video-item';item.dataset.url=video.url;item.innerHTML=`<div class="video-thumb"><img data-src="${video.thumb}" alt="${video.title}" class="lazy-load"><div class="play-overlay"><i class="fas fa-play"></i></div></div><div class="video-info"><div class="video-title">${video.title}</div></div>`}videosList.appendChild(item)});initLazyLoad()}function initLazyLoad(){const lazyImages=document.querySelectorAll('.lazy-load');if('IntersectionObserver'in window){const imageObserver=new IntersectionObserver((entries,observer)=>{entries.forEach(entry=>{if(entry.isIntersecting){const img=entry.target;img.src=img.dataset.src;img.classList.remove('lazy-load');imageObserver.unobserve(img)}})});lazyImages.forEach(img=>imageObserver.observe(img))}else{lazyImages.forEach(img=>{img.src=img.dataset.src;img.classList.remove('lazy-load')})}}function playVideo(url,thumb,title){if(!url)return;if(dp){dp.destroy();dp=null}const loadTimeout=setTimeout(()=>{showCompatibilityAlert('视频加载超时，请检查网络连接')},15000);try{const isIOSDevice=/iPad|iPhone|iPod/.test(navigator.userAgent)&&!window.MSStream;dp=new DPlayer({container:document.getElementById('dplayer-container'),contextmenu:[],video:{url:url,pic:thumb,type:(url.toLowerCase().endsWith('.m3u8')||url.toLowerCase().endsWith('.js'))?'hls':'auto'},hls:{liveSyncDurationCount:3,maxMaxBufferLength:30,enableWorker:true},autoHide:true,hideControlsAfter:isIOSDevice?3000:3000,errorHandler:function(error){console.error('播放错误:',error);showCompatibilityAlert('视频播放失败，请重试');clearTimeout(loadTimeout)}});let durationStabilized=false;let lastDuration=0;disableVideoContextMenu();dp.on('canplay',function(){clearTimeout(loadTimeout);document.getElementById('compatibility-alert').style.display='none';setTimeout(()=>{dp.controller.hide();const isIOSCanPlay=/iPad|iPhone|iPod/.test(navigator.userAgent)&&!window.MSStream;if(isIOSCanPlay){const dplayerVideo=document.querySelector('.dplayer-video-current');if(dplayerVideo){setupIOSAutoHide(dplayerVideo)}}},100);if(!durationStabilized){const initialDuration=dp.video.duration;lastDuration=initialDuration;const durationCheck=setInterval(()=>{if(dp.video.duration!==lastDuration){lastDuration=dp.video.duration}else{updateDurationDisplay(lastDuration);durationStabilized=true;clearInterval(durationCheck)}},500)}});dp.on('error',function(){clearTimeout(loadTimeout);showCompatibilityAlert('视频播放失败，请重试')})}catch(error){console.error('播放器初始化失败:',error);showCompatibilityAlert('播放器初始化失败，请刷新页面重试');clearTimeout(loadTimeout)}}function updateDurationDisplay(duration){if(!dp||!duration||isNaN(duration))return;const minutes=Math.floor(duration/60);const seconds=Math.floor(duration%60);const timeDisplay=`${minutes.toString().padStart(2,'0')}:${seconds.toString().padStart(2,'0')}`;const timeElement=document.querySelector('.dplayer-ptime');if(timeElement){timeDisplay.textContent=timeDisplay}}function setupIOSAutoHide(videoElement){let hideTimeout;function showControls(){videoElement.controls=true;if(hideTimeout)clearTimeout(hideTimeout)}function hideControls(){videoElement.controls=false}videoElement.addEventListener('click',function(){if(videoElement.controls){hideControls()}else{showControls();hideTimeout=setTimeout(hideControls,3000)}});videoElement.addEventListener('touchstart',function(){showControls();hideTimeout=setTimeout(hideControls,3000)});hideControls()}function showCompatibilityAlert(message){const alert=document.getElementById('compatibility-alert');const messageElement=document.getElementById('compatibility-message');if(alert&&messageElement){messageElement.textContent=message;alert.style.display='flex';setTimeout(()=>{alert.style.display='none'},5000)}}function initAppUI(){initCategories();loadCategoryVideos(currentCategory);document.getElementById('categories-container').addEventListener('click',function(e){const btn=e.target.closest('.category-btn');if(btn){const categoryId=btn.dataset.category;if(categoryId!==currentCategory){currentCategory=categoryId;folderHistory=[];document.querySelectorAll('.category-btn').forEach(b=>b.classList.remove('active'));btn.classList.add('active');loadCategoryVideos(categoryId)}}});document.getElementById('videos-list').addEventListener('click',function(e){const item=e.target.closest('.video-item');if(!item)return;if(item.classList.contains('back-folder')){if(folderHistory.length>0){const prevFolder=folderHistory.pop();currentCategory=prevFolder.categoryId;loadCategoryVideos(currentCategory,prevFolder.isFolder)}return}if(item.classList.contains('folder-item')){const folderId=item.dataset.folderId;if(window.videoData[folderId]){folderHistory.push({categoryId:currentCategory,isFolder:true});currentCategory=folderId;loadCategoryVideos(folderId,true)}return}const url=item.dataset.url;const thumb=item.querySelector('img')?.src||'';const title=item.querySelector('.video-title')?.textContent||'';if(url){playVideo(url,thumb,title)}});document.getElementById('close-alert').addEventListener('click',function(){document.getElementById('compatibility-alert').style.display='none'});const backToTop=document.getElementById('back-to-top');if(backToTop){backToTop.addEventListener('click',function(){window.scrollTo({top:0,behavior:'smooth'})});window.addEventListener('scroll',function(){if(window.pageYOffset>300){backToTop.classList.add('show')}else{backToTop.classList.remove('show')}})}const userAgent=navigator.userAgent;const isIOS=/iPad|iPhone|iPod/.test(userAgent)&&!window.MSStream;const isAndroid=/Android/.test(userAgent);const isMobile=isIOS||isAndroid;if(isMobile){document.body.classList.add('mobile-device')}showCompatibilityAlert('正在检测您的设备兼容性...');setTimeout(()=>{if(isIOS){showCompatibilityAlert('检测到iOS设备，已启用兼容模式')}else if(isAndroid){showCompatibilityAlert('检测到Android设备，已启用兼容模式')}else{showCompatibilityAlert('设备兼容性检测完成，支持高清视频播放')}document.getElementById('compatibility-alert').style.display='none'},3000)}initAppUI()});
