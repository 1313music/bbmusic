document.addEventListener("DOMContentLoaded",(function(){const e={audioPlayer:document.getElementById("audio-player"),playPauseBtn:document.getElementById("play-pause-btn"),playIcon:document.getElementById("play-icon"),pauseIcon:document.getElementById("pause-icon"),prevBtn:document.getElementById("prev-btn"),nextBtn:document.getElementById("next-btn"),playModeBtn:document.getElementById("play-mode-btn"),modeIcon:document.getElementById("mode-icon"),progressBar:document.getElementById("progress-bar"),progress:document.getElementById("progress"),currentTimeElement:document.getElementById("current-time"),totalTimeElement:document.getElementById("total-time"),songTitleElement:document.getElementById("song-title"),songArtistElement:document.getElementById("song-artist"),lyricsSongTitleElement:document.getElementById("lyrics-song-title"),lyricsSongArtistElement:document.getElementById("lyrics-song-artist"),coverImage:document.getElementById("cover-image"),albumCover:document.getElementById("album-cover"),songsListDesktop:document.getElementById("songs-list-desktop"),songsListMobile:document.getElementById("songs-list-mobile"),albumsList:document.getElementById("albums-list"),cloudBtn:document.getElementById("cloud-btn"),coverPage:document.getElementById("cover-page"),lyricsPage:document.getElementById("lyrics-page"),mobileSongsCollapse:document.getElementById("mobile-songs-collapse"),mobileSongsContainer:document.getElementById("mobile-songs-container"),commentsToggleBtn:document.getElementById("comments-toggle-btn"),walineContainer:document.getElementById("waline"),backToTopBtn:document.getElementById("back-to-top"),lyricsContainer:document.querySelector(".lyrics-container"),lyricsContent:document.querySelector(".lyrics-content")};let t=0,n=!1,s=0,o=null,i=window.localMusicList||[],a=[],l=-1,r="cover",c=null,d=null;function u(){"IntersectionObserver"in window?(window.imageObserver=new IntersectionObserver(((e,t)=>{e.forEach((e=>{if(e.isIntersecting){const n=e.target,s=n.getAttribute("data-src");s&&(n.src=s,n.removeAttribute("data-src"),n.onload=()=>{n.style.opacity="0",n.style.transition="opacity 0.3s",n.classList.add("lazy-loaded"),requestAnimationFrame((()=>{n.style.opacity="1"}))},t.unobserve(n))}}))}),{rootMargin:"50px 0px",threshold:.01}),document.querySelectorAll("img[data-src]").forEach((e=>{window.imageObserver.observe(e)}))):function(){const e=document.querySelectorAll("img[data-src]");let t,n;function s(){e.forEach((e=>{if(e.getAttribute("data-src")){const t=e.getBoundingClientRect();if(t.top<=window.innerHeight&&t.bottom>=0&&t.left<=window.innerWidth&&t.right>=0){const t=e.getAttribute("data-src");e.src=t,e.removeAttribute("data-src"),e.onload=()=>{e.style.opacity="0",e.style.transition="opacity 0.3s",e.classList.add("lazy-loaded"),requestAnimationFrame((()=>{e.style.opacity="1"}))}}}}));0===document.querySelectorAll("img[data-src]").length&&(window.removeEventListener("scroll",s),window.removeEventListener("resize",s))}s(),window.addEventListener("scroll",(()=>{t&&clearTimeout(t),t=setTimeout((()=>{s()}),200)})),window.addEventListener("resize",(()=>{n&&clearTimeout(n),n=setTimeout((()=>{s()}),200)}))}()}function m(s){if(s!==o)if(s.startsWith("netease_playlist_")){o=s;const a=neteasePlaylists.find((e=>e.id===s));if(!a)return e.songsListDesktop&&(e.songsListDesktop.innerHTML='<div class="song-item"><div class="song-details"><div class="song-name">未找到网易云歌单配置</div></div></div>'),void(e.songsListMobile&&(e.songsListMobile.innerHTML='<div class="song-item"><div class="song-details"><div class="song-name">未找到网易云歌单配置</div></div></div>'));e.songsListDesktop&&(e.songsListDesktop.innerHTML='<div class="song-item"><div class="song-details"><div class="song-name">正在加载网易云歌单...</div></div></div>'),e.songsListMobile&&(e.songsListMobile.innerHTML='<div class="song-item"><div class="song-details"><div class="song-name">正在加载网易云歌单...</div></div></div>'),fetch("https://music.zhheo.com/meting-api/?server=netease&type=playlist&id="+a.playlistId+"&r="+Math.random()).then((e=>e.json())).then((s=>{if(s&&s.length>0){if(i=s.map(((e,t)=>({name:e.name||"未知歌曲",artist:e.artist||"未知艺术家",album:e.album||e.artist||"网易云歌单",src:e.url||"",cover:e.pic||"img/default.jpg",neteaseId:e.id,lrc:e.lrc}))),g(),y(),i.length>0){const s=e.audioPlayer.src;i.some((e=>e.src===s))||(t=0,h(i[t]),n&&e.audioPlayer.addEventListener("loadedmetadata",(function t(){E(),e.audioPlayer.removeEventListener("loadedmetadata",t)})))}}else e.songsListDesktop&&(e.songsListDesktop.innerHTML='<div class="song-item"><div class="song-details"><div class="song-name">加载网易云歌单失败</div></div></div>'),e.songsListMobile&&(e.songsListMobile.innerHTML='<div class="song-item"><div class="song-details"><div class="song-name">加载网易云歌单失败</div></div></div>')})).catch((t=>{console.error("加载网易云歌单失败:",t),e.songsListDesktop&&(e.songsListDesktop.innerHTML='<div class="song-item"><div class="song-details"><div class="song-name">加载网易云歌单失败</div></div></div>'),e.songsListMobile&&(e.songsListMobile.innerHTML='<div class="song-item"><div class="song-details"><div class="song-name">加载网易云歌单失败</div></div></div>')}))}else{if(o=s,musicAlbums){const e=musicAlbums.find((e=>e.id===s));e&&(i=[...e.songs])}if(g(),y(),i.length>0){const s=e.audioPlayer.src;i.some((e=>e.src===s))||(t=0,h(i[t]),n&&e.audioPlayer.addEventListener("loadedmetadata",(function t(){E(),e.audioPlayer.removeEventListener("loadedmetadata",t)})))}}}function g(){const t=e.songsListDesktop,n=e.songsListMobile;t&&n?(t.style.animation="none",n.style.animation="none",t.offsetWidth,n.offsetWidth,t.style.animation="slideInUp 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275)",n.style.animation="slideInUp 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275)"):console.warn("Song list elements not found for animation")}function y(){if(!e.songsListDesktop||!e.songsListMobile)return void console.warn("Song list elements not found for rendering");if(e.songsListDesktop.innerHTML="",e.songsListMobile.innerHTML="",0===i.length){const t=document.createElement("div");return t.className="song-item",t.innerHTML='\n                        <div class="song-details">\n                            <div class="song-name">暂无歌曲</div>\n                        </div>\n                    ',e.songsListDesktop.appendChild(t),void e.songsListMobile.appendChild(t.cloneNode(!0))}const n=document.createDocumentFragment(),s=document.createDocumentFragment();i.forEach(((i,a)=>{const l=e.audioPlayer.src.includes(i.src);let r;if(l&&(t=a),o&&o.startsWith("netease_playlist_"))r=i.album||"未知专辑";else{const e=musicAlbums.find((e=>e.id===o));r=e?e.name:"未知专辑"}const c=`\n                        <div class="song-number">${a+1}</div>\n                        <div class="song-details">\n                            <div class="song-name">${i.name}</div>\n                            <div class="song-artist-name">${r}</div>\n                        </div>\n                    `,d=document.createElement("div");d.className="song-item",d.dataset.index=a,l&&d.classList.add("active"),d.innerHTML=c,n.appendChild(d);const u=d.cloneNode(!0);s.appendChild(u)})),e.songsListDesktop.appendChild(n),e.songsListMobile.appendChild(s),function(){const t=e.songsListDesktop.querySelectorAll(".song-item"),n=e.songsListMobile.querySelectorAll(".song-item");[...t,...n].forEach(((e,t)=>{e.style.animation="none",e.style.opacity="0",e.offsetWidth,e.style.animation=`fadeInRight 0.5s ease-out ${.05*t}s both`}))}()}function v(n){const s=n.target.closest(".song-item");if(!s)return;const o=parseInt(s.dataset.index);isNaN(o)||o<0||o>=i.length||(t=o,p(),h(i[t]),e.audioPlayer.addEventListener("loadedmetadata",(function t(){f(),E(),e.audioPlayer.removeEventListener("loadedmetadata",t)})),e.audioPlayer.addEventListener("error",(function t(){f(),L("音频加载失败，请检查网络连接"),e.audioPlayer.removeEventListener("error",t)})))}function p(){if(e.playPauseBtn&&e.playIcon&&e.pauseIcon){if(e.playPauseBtn.classList.add("loading"),e.playIcon.style.display="none",e.pauseIcon.style.display="none",!e.playPauseBtn.querySelector(".loading-indicator")){const t=document.createElement("div");t.className="loading-indicator",t.innerHTML='<svg class="svg-icon" style="animation: spin 1s linear infinite;"><use href="#icon-play"></use></svg>',e.playPauseBtn.appendChild(t)}}else console.warn("Play button elements not found")}function f(){if(!e.playPauseBtn||!e.playIcon||!e.pauseIcon)return void console.warn("Play button elements not found for hiding loading state");e.playPauseBtn.classList.remove("loading");const t=e.playPauseBtn.querySelector(".loading-indicator");t&&t.remove(),n?(e.playIcon.style.display="none",e.pauseIcon.style.display="block"):(e.playIcon.style.display="block",e.pauseIcon.style.display="none")}function L(e){const t=document.createElement("div");t.className="error-toast",t.innerHTML=`\n                    <i class="fa fa-exclamation-circle"></i>\n                    <span>${e}</span>\n                `,document.body.appendChild(t),setTimeout((()=>{t.classList.add("fade-out"),setTimeout((()=>{t.parentNode&&t.parentNode.removeChild(t)}),300)}),3e3)}function h(n){if(!n)return;if(p(),e.songTitleElement.textContent=n.name,o&&o.startsWith("netease_playlist_"))e.songArtistElement.textContent=n.album||"未知专辑",e.lyricsSongArtistElement.textContent=n.album||"未知专辑";else{const t=musicAlbums.find((e=>e.id===o));e.songArtistElement.textContent=t?t.name:"未知专辑",e.lyricsSongArtistElement.textContent=t?t.name:"未知专辑"}let s="img/1.jpg";if(n.cover)s=n.cover;else if(o&&musicAlbums){const e=musicAlbums.find((e=>e.id===o));if(e&&e.cover)s=e.cover;else for(const e of musicAlbums)if(e.songs&&e.songs.some((e=>e.src===n.src))&&e.cover){s=e.cover;break}}e.coverImage?"img/default.jpg"!==s?(e.coverImage.removeAttribute("src"),e.coverImage.setAttribute("data-src",s),!function(e){const t=e.getBoundingClientRect();return t.top>=0&&t.left>=0&&t.bottom<=(window.innerHeight||document.documentElement.clientHeight)&&t.right<=(window.innerWidth||document.documentElement.clientWidth)}(e.coverImage)&&window.imageObserver?window.imageObserver.observe(e.coverImage):(e.coverImage.src=s,e.coverImage.removeAttribute("data-src"),e.coverImage.onload=()=>{e.coverImage.style.opacity="0",e.coverImage.style.transition="opacity 0.3s",e.coverImage.classList.add("lazy-loaded"),requestAnimationFrame((()=>{e.coverImage.style.opacity="1"}))})):e.coverImage.src=s:console.warn("Cover image element not found"),e.audioPlayer?(e.audioPlayer.src=n.src,function(){document.querySelectorAll(".song-item.active").forEach((e=>e.classList.remove("active")));document.querySelectorAll(`.song-item[data-index="${t}"]`).forEach((e=>e.classList.add("active")))}(),async function(n,s){a=[],l=-1,e.lyricsContent&&(e.lyricsContent.innerHTML='<div class="lyrics-empty">加载歌词中...</div>');const o=neteasePlaylists?.some((e=>e.id===s));try{o?await async function(e){const n=i[t];if(!n)throw new Error("无法获取当前歌曲信息");if(n.lrc)try{const e=await fetch(n.lrc),t=await e.text();if(t?.trim()&&!t.includes("error")&&!t.includes("暂无歌词"))return a=H(t),void A()}catch(e){console.warn("使用歌曲歌词URL失败:",e.message)}let s=n.neteaseId;if(!s){const t=`https://music.zhheo.com/meting-api/?server=netease&type=search&id=${encodeURIComponent(e)}`,n=await fetch(t),o=await n.json();if(!o?.length)throw new Error("未找到歌曲信息");if(s=o[0].id,!s)throw new Error("无法获取歌曲ID")}const o=`https://music.zhheo.com/meting-api/?server=netease&type=lrc&id=${s}`,l=await fetch(o),r=await l.text();if(!r?.trim()||r.includes("error")||r.includes("暂无歌词")){const e=`https://api.injahow.cn/meting/?type=lrc&id=${s}`,t=await fetch(e),n=await t.text();if(!n?.trim()||n.includes("error")||n.includes("暂无歌词"))throw new Error("该歌曲暂无歌词");a=H(n)}else a=H(r);A()}(n):await async function(){const e=i[t];if(!e?.src)return a=[],void A();const n=e.lrc||e.src.replace(/\.(mp3|flac|wav|ogg|m4a)$/i,".lrc");try{const e=await fetch(n);if(!e.ok)throw new Error("歌词文件不存在");const t=await e.text();if(!t.trim())throw new Error("歌词文件为空");a=H(t)}catch{a=[]}A()}()}catch(e){console.error("加载歌词失败:",e)}0===a.length&&e.lyricsContent&&(e.lyricsContent.innerHTML='<div class="lyrics-empty">暂无歌词</div>')}(n.name,o),S(),q(),d&&e.audioPlayer.removeEventListener("error",d),c&&e.audioPlayer.removeEventListener("loadedmetadata",c),d=b,e.audioPlayer.addEventListener("error",d),c=function(){f(),function(){if(!e.audioPlayer||!e.totalTimeElement)return void console.warn("更新总时长所需的关键元素未找到");const t=e.audioPlayer.duration;t&&!isNaN(t)&&(e.totalTimeElement.textContent=k(t))}()},e.audioPlayer.addEventListener("loadedmetadata",c)):(console.warn("Audio player element not found"),f())}function b(e){f();const t=e.target.error;let n="音频加载失败";switch(t.code){case t.MEDIA_ERR_ABORTED:n="音频加载被中止";break;case t.MEDIA_ERR_NETWORK:n="网络错误，音频加载失败";break;case t.MEDIA_ERR_DECODE:n="音频解码失败";break;case t.MEDIA_ERR_SRC_NOT_SUPPORTED:n="音频格式不支持";break;default:n="音频加载失败，请检查网络连接"}L(n),console.error("音频加载错误:",t)}function E(){if(0===i.length)return;if(!(e.audioPlayer&&e.playIcon&&e.pauseIcon&&e.albumCover))return void console.warn("播放所需的关键元素未找到");p();const t=e.audioPlayer.play();if(void 0!==t)t.then((()=>{f(),n=!0,e.playIcon.style.display="none",e.pauseIcon.style.display="block",e.albumCover.classList.add("playing"),V()})).catch((e=>{f(),console.error("播放失败:",e);let t="播放失败";t="NotAllowedError"===e.name?"浏览器阻止了自动播放，请点击播放按钮":"NotSupportedError"===e.name?"音频格式不支持":"播放失败，请重试",L(t)}));else try{e.audioPlayer.play(),n=!0,e.playIcon.style.display="none",e.pauseIcon.style.display="block",e.albumCover.classList.add("playing"),f(),V()}catch(e){f(),console.error("播放失败:",e),L("播放失败，请重试")}}function C(){if(0!==i.length){if(2===s){const e=Math.floor(Math.random()*i.length);t=e}else if(3===s)t=(t+1)%i.length;else if(0===s)t=(t+1)%i.length;else{if(!(t<i.length-1))return;t++}h(i[t]),e.audioPlayer.addEventListener("loadedmetadata",(function t(){E(),e.audioPlayer.removeEventListener("loadedmetadata",t)}))}}function M(){if(0!==i.length){if(2===s){const e=Math.floor(Math.random()*i.length);t=e}else if(3===s)t=(t-1+i.length)%i.length;else if(0===s)t=(t-1+i.length)%i.length;else{if(!(t>0))return;t--}h(i[t]),e.audioPlayer.addEventListener("loadedmetadata",(function t(){E(),e.audioPlayer.removeEventListener("loadedmetadata",t)}))}}function P(){if(!e.audioPlayer||!e.progress)return void console.warn("更新进度所需的关键元素未找到");const{duration:t,currentTime:n}=e.audioPlayer;if(t&&!isNaN(t)){const s=n/t*100;e.progress.style.width=`${s}%`}!function(){if(!e.audioPlayer||!e.currentTimeElement)return void console.warn("更新当前时间所需的关键元素未找到");const t=e.audioPlayer.currentTime;e.currentTimeElement.textContent=k(t)}(),D()}function k(e){const t=Math.floor(e/60),n=Math.floor(e%60);return`${t.toString().padStart(2,"0")}:${n.toString().padStart(2,"0")}`}function B(t){if(!e.progressBar||!e.audioPlayer)return void console.warn("设置进度条所需的关键元素未找到");const n=e.progressBar.clientWidth,s=e.progressBar.getBoundingClientRect(),o=t.clientX-s.left,i=e.audioPlayer.duration;if(i){const t=o/n*i;e.audioPlayer.currentTime=t}}function w(){if(e.modeIcon&&e.playModeBtn)switch(s=0===s?3:3===s?2:2===s?1:0,s){case 0:e.modeIcon.innerHTML='<path d="M8 20V21.9324C8 22.2086 7.77614 22.4324 7.5 22.4324C7.38303 22.4324 7.26977 22.3914 7.17991 22.3165L3.06093 18.8841C2.84879 18.7073 2.82013 18.392 2.99691 18.1799C3.09191 18.0659 3.23264 18 3.38103 18L18 18C19.1046 18 20 17.1045 20 16V7.99997H22V16C22 18.2091 20.2091 20 18 20H8ZM16 3.99997V2.0675C16 1.79136 16.2239 1.5675 16.5 1.5675C16.617 1.5675 16.7302 1.60851 16.8201 1.68339L20.9391 5.11587C21.1512 5.29266 21.1799 5.60794 21.0031 5.82008C20.9081 5.93407 20.7674 5.99998 20.619 5.99998L6 5.99997C4.89543 5.99997 4 6.8954 4 7.99997V16H2V7.99997C2 5.79083 3.79086 3.99997 6 3.99997H16Z"/>',e.playModeBtn.style.backgroundColor="transparent",e.playModeBtn.style.color="var(--text-secondary)";break;case 1:e.modeIcon.innerHTML='<path d="M17 3.99998V2.0675C17 1.79136 17.2239 1.5675 17.5 1.5675C17.617 1.5675 17.7302 1.60851 17.8201 1.68339L21.9391 5.11587C22.1512 5.29266 22.1799 5.60794 22.0031 5.82008C21.9081 5.93407 21.7674 5.99998 21.619 5.99998H2V3.99998H17ZM2 18H22V20H2V18ZM2 11H22V13H2V11Z"/>',e.playModeBtn.style.backgroundColor="transparent",e.playModeBtn.style.color="var(--text-secondary)";const t=e.playModeBtn.querySelector(".loop-dot");t&&t.remove();break;case 2:e.modeIcon.innerHTML='<path d="M18 17.8832V16L23 19L18 22V19.9095C14.9224 19.4698 12.2513 17.4584 11.0029 14.5453L11 14.5386L10.9971 14.5453C9.57893 17.8544 6.32508 20 2.72483 20H2V18H2.72483C5.52503 18 8.05579 16.3312 9.15885 13.7574L9.91203 12L9.15885 10.2426C8.05579 7.66878 5.52503 6 2.72483 6H2V4H2.72483C6.32508 4 9.57893 6.14557 10.9971 9.45473L11 9.46141L11.0029 9.45473C12.2513 6.5416 14.9224 4.53022 18 4.09051V2L23 5L18 8V6.11684C15.7266 6.53763 13.7737 8.0667 12.8412 10.2426L12.088 12L12.8412 13.7574C13.7737 15.9333 15.7266 17.4624 18 17.8832Z"/>',e.playModeBtn.style.backgroundColor="transparent",e.playModeBtn.style.color="var(--text-secondary)";break;case 3:e.modeIcon.innerHTML='<path d="M8 20V21.9325C8 22.2086 7.77614 22.4325 7.5 22.4325C7.38303 22.4325 7.26977 22.3915 7.17991 22.3166L3.06093 18.8841C2.84879 18.7073 2.82013 18.392 2.99691 18.1799C3.09191 18.0659 3.23264 18 3.38103 18L18 18C19.1046 18 20 17.1046 20 16V8H22V16C22 18.2091 20.2091 20 18 20H8ZM16 2.0675C16 1.79136 16.2239 1.5675 16.5 1.5675C16.617 1.5675 16.7302 1.60851 16.8201 1.68339L20.9391 5.11587C21.1512 5.29266 21.1799 5.60794 21.0031 5.82008C20.9081 5.93407 20.7674 5.99998 20.619 5.99998L6 6C4.89543 6 4 6.89543 4 8V16H2V8C2 5.79086 3.79086 4 6 4H16V2.0675ZM11 8H13V16H11V10H9V9L11 8Z"/>',e.playModeBtn.style.backgroundColor="transparent",e.playModeBtn.style.color="var(--text-secondary)"}else console.warn("切换播放模式所需的关键元素未找到")}function I(){const e=document.querySelector(".cloud-qr-modal");e&&document.body.removeChild(e);const t=document.createElement("div");t.className="cloud-qr-modal",t.innerHTML='\n                    <div class="qr-modal-content">\n                        <div class="qr-modal-header">\n                            <h3>上传歌曲至网易云盘</h3>\n                            <button class="qr-modal-close">&times;</button>\n                        </div>\n                        <div class="qr-modal-body">\n                            <img src="img/xcx.jpg" alt="云盘二维码" class="qr-code-image">\n                            <p>扫码使用小程序上传歌曲</p>\n                            <p><a href="https://mp.weixin.qq.com/s/pHsFSPTn3Cd7MXV81J4NHg" target="_blank" class="guide-button">使用指南</a></p>\n                        </div>\n                    </div>\n                ',document.body.appendChild(t),setTimeout((()=>{t.style.opacity="1",t.style.visibility="visible"}),10);const n=t.querySelector(".qr-modal-close");n&&n.addEventListener("click",(function(){const e=t.querySelector(".qr-modal-content");e&&(e.style.animation="modalBounceOut 0.4s ease-in forwards"),setTimeout((()=>{document.body.contains(t)&&document.body.removeChild(t)}),400)})),t.addEventListener("click",(function(e){if(e.target===t){const e=t.querySelector(".qr-modal-content");e&&(e.style.animation="modalBounceOut 0.4s ease-in forwards"),setTimeout((()=>{document.body.contains(t)&&document.body.removeChild(t)}),400)}}))}e.audioPlayer?e.audioPlayer.volume=.8:console.warn("Audio player element not found");const T={playPause:null,prev:null,next:null,playMode:null,cloud:null,timeupdate:null,progressClick:null,ended:null,albumCover:null,songClickDesktop:null,songClickMobile:null,lyricsToggle:null};function x(){e.coverPage&&e.lyricsPage?"cover"===r?(e.coverPage.classList.remove("active"),e.lyricsPage.classList.add("active"),r="lyrics"):(e.lyricsPage.classList.remove("active"),e.coverPage.classList.add("active"),r="cover"):console.warn("切换页面所需的关键元素未找到")}function H(e){const t=e.split("\n"),n=[];for(let e=0;e<t.length;e++){const s=t[e].trim();if(!s)continue;const o=s.match(/^\[(\d{1,2}):(\d{1,2})(?:\.(\d{2,3}))?\]<(?:(\d{1,2}):(\d{1,2})(?:\.(\d{2,3}))?>)?(.*)$/);if(o){const e=parseInt(o[1]),t=parseInt(o[2]);let s=0;o[3]&&(s=2===o[3].length?10*parseInt(o[3]):parseInt(o[3]));let i=o[7]||"";i=i.replace(/<\d{1,2}:\d{1,2}(?:\.\d{2,3})?>/g,""),i=i.trim();const a=60*e+t+s/1e3;n.push({time:a,text:i||"♪"});continue}const i=s.match(/^\[(\d{1,2}):(\d{1,2})(?:\.(\d{2,3}))?\](.*)$/);if(i){const e=parseInt(i[1]),t=parseInt(i[2]);let s=0;i[3]&&(s=2===i[3].length?10*parseInt(i[3]):parseInt(i[3]));const o=i[4].trim(),a=60*e+t+s/1e3;n.push({time:a,text:o||"♪"})}}return n.sort(((e,t)=>e.time-t.time)),n}function S(){const e=document.getElementById("lyrics-indicator"),t=document.getElementById("lyrics-indicator-2"),n=!(!(a.length>0)||1===a.length&&"♪"===a[0].text||1===a.length&&"纯音乐"===a[0].text||1===a.length&&"无歌词"===a[0].text);e&&(n?(e.classList.add("active"),e.title="有歌词"):(e.classList.remove("active"),e.title="无歌词")),t&&(n?(t.classList.add("active"),t.title="有歌词"):(t.classList.remove("active"),t.title="无歌词"))}function A(){if(!e.lyricsContent)return;if(e.lyricsContent.classList.remove("single-line"),S(),0===a.length)return void(e.lyricsContent.innerHTML='<div class="lyrics-empty">暂无歌词</div>');(1===a.length||2===a.length&&"♪"===a[1].text||2===a.length&&"纯音乐"===a[1].text||2===a.length&&"无歌词"===a[1].text)&&e.lyricsContent.classList.add("single-line");let t="";for(let e=0;e<a.length;e++)t+=`<div class="lyrics-line" data-index="${e}" data-time="${a[e].time}">${a[e].text}</div>`;e.lyricsContent.innerHTML=t,l=-1,n&&D()}function D(){if(!e.audioPlayer||0===a.length)return;const t=e.audioPlayer.currentTime;let n=-1;for(let e=a.length-1;e>=0;e--)if(t>=a[e].time){n=e;break}if(n!==l){if(e.lyricsContent.querySelectorAll(".lyrics-line").forEach((e=>{e.classList.remove("active","past","next","past-1","past-2","past-3","next-1","next-2","next-3")})),n>=0){const t=e.lyricsContent.querySelector(`.lyrics-line[data-index="${n}"]`);if(t){t.classList.add("active");for(let t=1;t<=3;t++){const s=n-t;if(s>=0){const n=e.lyricsContent.querySelector(`.lyrics-line[data-index="${s}"]`);n&&n.classList.add(`past-${t}`)}}for(let t=1;t<=3;t++){const s=n+t;if(s<a.length){const n=e.lyricsContent.querySelector(`.lyrics-line[data-index="${s}"]`);n&&n.classList.add(`next-${t}`)}}const s=e.lyricsContent,o=s.clientHeight,i=t.clientHeight,l=t.offsetTop-o/2+i/2;s.scrollTop=l}}l=n}}function q(){if(!("mediaSession"in navigator))return;const e=i[t];if(!e)return;let n="";l>=0&&a[l]&&(n=a[l].text);let s="img/1.jpg";if(e.cover)s=e.cover;else if(o&&musicAlbums){const e=musicAlbums.find((e=>e.id===o));e&&e.cover&&(s=e.cover)}if(!s.startsWith("http")&&!s.startsWith("//")){s=window.location.origin+window.location.pathname.substring(0,window.location.pathname.lastIndexOf("/"))+"/"+s}const r=new MediaMetadata({title:e.name||"未知歌曲",artist:e.artist||"未知艺术家",album:e.album||o||"未知专辑",artwork:[{src:s,sizes:"96x96",type:"image/jpeg"},{src:s,sizes:"128x128",type:"image/jpeg"},{src:s,sizes:"192x192",type:"image/jpeg"},{src:s,sizes:"256x256",type:"image/jpeg"},{src:s,sizes:"384x384",type:"image/jpeg"},{src:s,sizes:"512x512",type:"image/jpeg"}]});navigator.mediaSession.metadata=r,n&&(navigator.mediaSession.metadata=new MediaMetadata({title:e.name||"未知歌曲",artist:n,album:e.album||o||"未知专辑",artwork:r.artwork}))}e.playPauseBtn&&(T.playPause=()=>{e.playPauseBtn.classList.contains("loading")||(n?e.audioPlayer&&e.playIcon&&e.pauseIcon&&e.albumCover?(e.audioPlayer.pause(),n=!1,e.playIcon.style.display="block",e.pauseIcon.style.display="none",e.albumCover.classList.remove("playing"),V()):console.warn("暂停所需的关键元素未找到"):E())},e.playPauseBtn.addEventListener("click",T.playPause)),e.prevBtn&&(T.prev=M,e.prevBtn.addEventListener("click",T.prev)),e.nextBtn&&(T.next=C,e.nextBtn.addEventListener("click",T.next)),e.playModeBtn&&(T.playMode=w,e.playModeBtn.addEventListener("click",T.playMode),e.playModeBtn.addEventListener("mouseenter",(function(){this.style.background="rgba(212, 175, 55, 0.15)",this.style.color="var(--primary)",this.style.border="1px solid rgba(212, 175, 55, 0.4)",this.style.boxShadow="0 0 15px rgba(212, 175, 55, 0.3)",this.style.borderRadius="var(--radius-md)",this.style.transform="translateY(-2px)"})),e.playModeBtn.addEventListener("mouseleave",(function(){this.style.background="rgba(255, 255, 255, 0.05)",this.style.color="var(--text-secondary)",this.style.border="1px solid rgba(212, 175, 55, 0.2)",this.style.boxShadow="none",this.style.borderRadius="var(--radius-md)",this.style.transform="none"}))),e.cloudBtn&&(T.cloud=I,e.cloudBtn.addEventListener("click",T.cloud)),e.audioPlayer&&(T.timeupdate=P,e.audioPlayer.addEventListener("timeupdate",T.timeupdate),T.ended=function(){3===s?(e.audioPlayer.currentTime=0,E()):C(),setTimeout((()=>{q(),V()}),100)},e.audioPlayer.addEventListener("ended",T.ended)),e.progressBar&&(T.progressClick=B,e.progressBar.addEventListener("click",T.progressClick)),e.songsListDesktop&&(T.songClickDesktop=v,e.songsListDesktop.addEventListener("click",T.songClickDesktop)),e.songsListMobile&&(T.songClickMobile=v,e.songsListMobile.addEventListener("click",T.songClickMobile)),window.addEventListener("beforeunload",(function(){T.playPause&&e.playPauseBtn.removeEventListener("click",T.playPause),T.prev&&e.prevBtn.removeEventListener("click",T.prev),T.next&&e.nextBtn.removeEventListener("click",T.next),T.playMode&&e.playModeBtn.removeEventListener("click",T.playMode),T.cloud&&e.cloudBtn.removeEventListener("click",T.cloud),T.timeupdate&&e.audioPlayer.removeEventListener("timeupdate",T.timeupdate),T.progressClick&&e.progressBar.removeEventListener("click",T.progressClick),T.ended&&e.audioPlayer.removeEventListener("ended",T.ended),T.albumCover&&e.albumCover.removeEventListener("click",T.albumCover),T.songClickDesktop&&e.songsListDesktop.removeEventListener("click",T.songClickDesktop),T.songClickMobile&&e.songsListMobile.removeEventListener("click",T.songClickMobile)})),function(){if(musicAlbums&&musicAlbums.length>0){if(!e.albumsList)return void console.warn("Albums list element not found");e.albumsList.innerHTML="",neteasePlaylists&&neteasePlaylists.length>0&&neteasePlaylists.forEach((t=>{const n=document.createElement("div");n.className="album-item",n.dataset.id=t.id,n.innerHTML=`\n                                <div class="album-image">\n                                    <img data-src="${t.cover}" alt="${t.name}" loading="lazy">\n                                </div>\n                                <div class="album-info">\n                                    <h3 class="album-title">${t.name}</h3>\n                                </div>\n                            `,n.addEventListener("click",(()=>{m(t.id)})),e.albumsList.appendChild(n)})),musicAlbums.forEach((t=>{const n=document.createElement("div");n.className="album-item",n.dataset.id=t.id,n.innerHTML=`\n                            <div class="album-image">\n                                <img data-src="${t.cover}" alt="${t.name}" loading="lazy">\n                            </div>\n                            <div class="album-info">\n                                <h3 class="album-title">${t.name}</h3>\n                            </div>\n                        `,n.addEventListener("click",(()=>{m(t.id)})),e.albumsList.appendChild(n)})),u(),e.albumsList.querySelectorAll(".album-item").forEach(((e,t)=>{e.style.animation="none",e.style.opacity="0",e.offsetWidth,e.style.animation=`bounceIn 0.6s ease-out ${.1*t}s both`}))}}(),function(){if(!e.mobileSongsCollapse||!e.mobileSongsContainer)return;let t=!1,n=!1,s=null;const o=(i=function(){n||(t=!t,n=!0,requestAnimationFrame((()=>{t?e.mobileSongsContainer.classList.add("collapsed"):e.mobileSongsContainer.classList.remove("collapsed"),setTimeout((()=>{n=!1}),320)})))},a=30,function(){const e=this,t=arguments;clearTimeout(s),s=setTimeout((()=>{i.apply(e,t)}),a)});var i,a;e.mobileSongsCollapse.addEventListener("click",(function(){o()})),e.mobileSongsContainer.querySelector(".songs-header").addEventListener("click",(function(e){e.target.closest(".collapse-btn")||o()}))}(),function(){if(!e.progressBar||!e.audioPlayer)return void console.warn("初始化进度条拖拽所需的关键元素未找到");let t=!1;e.progressBar.addEventListener("mousedown",(function(n){t=!0,e.progressBar.classList.add("dragging"),B(n)})),document.addEventListener("mousemove",(function(n){if(t){const t=e.progressBar.clientWidth,s=e.progressBar.getBoundingClientRect(),o=n.clientX-s.left,i=e.audioPlayer.duration;if(i){const n=Math.max(0,Math.min(t,o))/t*i;e.audioPlayer.currentTime=n}}})),document.addEventListener("mouseup",(function(){t&&(t=!1,e.progressBar.classList.remove("dragging"))})),e.progressBar.addEventListener("touchstart",(function(n){t=!0;const s=n.touches[0],o=e.progressBar.getBoundingClientRect(),i=s.clientX-o.left,a=e.progressBar.clientWidth,l=e.audioPlayer.duration;if(l){const t=Math.max(0,Math.min(a,i))/a*l;e.audioPlayer.currentTime=t}})),document.addEventListener("touchmove",(function(n){if(t){const t=n.touches[0],s=e.progressBar.getBoundingClientRect(),o=t.clientX-s.left,i=e.progressBar.clientWidth,a=e.audioPlayer.duration;if(a){const t=Math.max(0,Math.min(i,o))/i*a;e.audioPlayer.currentTime=t}}})),document.addEventListener("touchend",(function(){t&&(t=!1,e.progressBar.classList.remove("dragging"))}))}(),e.backToTopBtn&&(window.addEventListener("scroll",(function(){window.scrollY>300?e.backToTopBtn.classList.add("visible"):e.backToTopBtn.classList.remove("visible")})),e.backToTopBtn.addEventListener("click",(function(){window.scrollTo({top:0,behavior:"smooth"})})),e.backToTopBtn.addEventListener("keydown",(function(e){"Enter"!==e.key&&" "!==e.key||(e.preventDefault(),window.scrollTo({top:0,behavior:"smooth"}))}))),neteasePlaylists&&neteasePlaylists.length>0?m(neteasePlaylists[0].id):musicAlbums&&musicAlbums.length>0?m(musicAlbums[0].id):function(){if(e.songsListDesktop.innerHTML="",e.songsListMobile.innerHTML="",0===i.length){const t=document.createElement("div");return t.className="song-item",t.innerHTML='\n                        <div class="song-details">\n                            <div class="song-name">暂无歌曲</div>\n                        </div>\n                    ',e.songsListDesktop.appendChild(t),void e.songsListMobile.appendChild(t.cloneNode(!0))}const n=document.createDocumentFragment(),s=document.createDocumentFragment();i.forEach(((i,a)=>{const l=e.audioPlayer.src.includes(i.src);let r;if(l&&(t=a),o&&o.startsWith("netease_playlist_"))r=i.album||"未知专辑";else{const e=musicAlbums.find((e=>e.id===o));r=e?e.name:"未知专辑"}const c=`\n                        <div class="song-number">${a+1}</div>\n                        <div class="song-details">\n                            <div class="song-name">${i.name}</div>\n                            <div class="song-artist-name">${r}</div>\n                        </div>\n                    `,d=document.createElement("div");d.className="song-item",d.dataset.index=a,l&&d.classList.add("active"),d.innerHTML=c,n.appendChild(d);const u=d.cloneNode(!0);s.appendChild(u)})),e.songsListDesktop.appendChild(n),e.songsListMobile.appendChild(s)}(),s=0,e.modeIcon&&e.playModeBtn&&(e.modeIcon.innerHTML='<path d="M8 20V21.9324C8 22.2086 7.77614 22.4324 7.5 22.4324C7.38303 22.4324 7.26977 22.3914 7.17991 22.3165L3.06093 18.8841C2.84879 18.7073 2.82013 18.392 2.99691 18.1799C3.09191 18.0659 3.23264 18 3.38103 18L18 18C19.1046 18 20 17.1045 20 16V7.99997H22V16C22 18.2091 20.2091 20 18 20H8ZM16 3.99997V2.0675C16 1.79136 16.2239 1.5675 16.5 1.5675C16.617 1.5675 16.7302 1.60851 16.8201 1.68339L20.9391 5.11587C21.1512 5.29266 21.1799 5.60794 21.0031 5.82008C20.9081 5.93407 20.7674 5.99998 20.619 5.99998L6 5.99997C4.89543 5.99997 4 6.8954 4 7.99997V16H2V7.99997C2 5.79083 3.79086 3.99997 6 3.99997H16Z"/>',e.playModeBtn.style.backgroundColor="transparent",e.playModeBtn.style.color="var(--text-secondary)"),i.length>0&&h(i[0]),function(){if(!e.albumCover||!e.coverPage||!e.lyricsPage)return;e.albumCover.addEventListener("click",(function(){x()}));const t=document.getElementById("lyrics-indicator"),n=document.getElementById("lyrics-indicator-2");t&&t.addEventListener("click",(function(){"cover"===r&&x()}));n&&n.addEventListener("click",(function(){"cover"===r&&x()}));e.lyricsPage.addEventListener("click",(function(e){if("lyrics"===r){const t=document.getElementById("progress-bar"),n=document.querySelector(".progress-container");if(e.target===t||e.target===n||t.contains(e.target)||n.contains(e.target))return;x()}})),e.coverPage.classList.add("active"),e.lyricsPage.classList.remove("active"),r="cover"}();const V=function(e,t){let n;return function(){const s=arguments,o=this;n||(e.apply(o,s),n=!0,setTimeout((()=>n=!1),t))}}((function(){"mediaSession"in navigator&&(navigator.mediaSession.playbackState=n?"playing":"paused",q())}),1e3);"mediaSession"in navigator?("mediaSession"in navigator&&(navigator.mediaSession.setActionHandler("play",(function(){e.audioPlayer.paused&&(e.audioPlayer.play(),n=!0,updatePlayPauseButton(),q())})),navigator.mediaSession.setActionHandler("pause",(function(){e.audioPlayer.paused||(e.audioPlayer.pause(),n=!1,updatePlayPauseButton())})),navigator.mediaSession.setActionHandler("previoustrack",(function(){playPrevious()})),navigator.mediaSession.setActionHandler("nexttrack",(function(){playNext()})),navigator.mediaSession.setActionHandler("seekto",(function(t){t.fastSeek&&"fastSeek"in e.audioPlayer?e.audioPlayer.fastSeek(t.seekTime):e.audioPlayer.currentTime=t.seekTime})),navigator.mediaSession.setActionHandler("stop",(function(){e.audioPlayer.pause(),e.audioPlayer.currentTime=0,n=!1,updatePlayPauseButton()}))),e.audioPlayer.addEventListener("play",V),e.audioPlayer.addEventListener("pause",V),e.audioPlayer.addEventListener("ended",V),e.audioPlayer.addEventListener("timeupdate",(function(){n&&a.length>0&&V()})),document.addEventListener("visibilitychange",(function(){document.hidden&&n&&q()})),console.log("MediaSession API 初始化完成")):console.log("当前浏览器不支持MediaSession API")}));
