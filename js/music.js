function initMusicPlayer(){const e={audioPlayer:document.getElementById("audio-player"),playPauseBtn:document.getElementById("play-pause-btn"),playIcon:document.getElementById("play-icon"),pauseIcon:document.getElementById("pause-icon"),prevBtn:document.getElementById("prev-btn"),nextBtn:document.getElementById("next-btn"),playModeBtn:document.getElementById("play-mode-btn"),modeIcon:document.getElementById("mode-icon"),progressBar:document.getElementById("progress-bar"),progress:document.getElementById("progress"),currentTimeElement:document.getElementById("current-time"),totalTimeElement:document.getElementById("total-time"),songTitleElement:document.getElementById("song-title"),songArtistElement:document.getElementById("song-artist"),coverImage:document.getElementById("cover-image"),albumCover:document.getElementById("album-cover"),songsListDesktop:document.getElementById("songs-list-desktop"),songsListMobile:document.getElementById("songs-list-mobile"),albumsList:document.getElementById("albums-list"),cloudBtn:document.getElementById("cloud-btn"),mobileSongsCollapse:document.getElementById("mobile-songs-collapse"),mobileSongsContainer:document.getElementById("mobile-songs-container"),commentsToggleBtn:document.getElementById("comments-toggle-btn"),walineContainer:document.getElementById("waline"),backToTopBtn:document.getElementById("back-to-top"),lyricsPage:document.getElementById("lyrics-page")};let t=0,n=!1,o=0,s=null,a=window.localMusicList||[],i=null,r=!1,l=null;function c(){return s&&window.musicAlbums?window.musicAlbums.find((e=>e.id===s)):null}function d(){const e=c();return e?e.artist:"未知艺术家"}function u(){const e=c();return e?e.name:"未知专辑"}let m,y=null,g=null,p=null,v=null;function f(){"IntersectionObserver"in window?(window.imageObserver=new IntersectionObserver(((e,t)=>{e.forEach((e=>{if(e.isIntersecting){const n=e.target,o=n.getAttribute("data-src");o&&(n.src=o,n.removeAttribute("data-src"),n.onload=()=>{n.style.opacity="0",n.style.transition="opacity 0.3s",n.classList.add("lazy-loaded"),requestAnimationFrame((()=>{n.style.opacity="1"}))},t.unobserve(n))}}))}),{rootMargin:"50px 0px",threshold:.01}),document.querySelectorAll("img[data-src]").forEach((e=>{window.imageObserver.observe(e)}))):function(){const e=document.querySelectorAll("img[data-src]");let t,n;function o(){e.forEach((e=>{if(e.getAttribute("data-src")){const t=e.getBoundingClientRect();if(t.top<=window.innerHeight&&t.bottom>=0&&t.left<=window.innerWidth&&t.right>=0){const t=e.getAttribute("data-src");e.src=t,e.removeAttribute("data-src"),e.onload=()=>{e.style.opacity="0",e.style.transition="opacity 0.3s",e.classList.add("lazy-loaded"),requestAnimationFrame((()=>{e.style.opacity="1"}))}}}}));0===document.querySelectorAll("img[data-src]").length&&(window.removeEventListener("scroll",o),window.removeEventListener("resize",o))}o(),window.addEventListener("scroll",(()=>{t&&clearTimeout(t),t=setTimeout((()=>{o()}),200)})),window.addEventListener("resize",(()=>{n&&clearTimeout(n),n=setTimeout((()=>{o()}),200)}))}()}function h(){if(window.musicAlbums&&window.musicAlbums.length>0){if(!e.albumsList)return void console.warn("Albums list element not found");e.albumsList.innerHTML="",window.musicAlbums.forEach((t=>{const n=document.createElement("div");n.className="album-item",n.dataset.id=t.id,n.innerHTML=`\n                            <div class="album-image">\n                                <img data-src="${t.cover}" alt="${t.name}" loading="lazy">\n                            </div>\n                            <div class="album-info">\n                                <h3 class="album-title">${t.name}</h3>\n                            </div>\n                        `,n.addEventListener("click",(()=>{L(t.id)})),e.albumsList.appendChild(n)})),f(),e.albumsList.querySelectorAll(".album-item").forEach(((e,t)=>{e.style.animation="none",e.style.opacity="0",e.offsetWidth,e.style.animation=`bounceIn 0.6s ease-out ${.1*t}s both`}))}}function L(o){const r="true"===sessionStorage.getItem("qualityUserAction");if(o!==s||r){if(s=o,i=null,window.musicAlbums){const n=function(e){return e&&window.musicAlbums?window.musicAlbums.find((t=>t.id===e)):null}(o);if(n){a=[...n.songs];if("true"===sessionStorage.getItem("qualityUserAction")&&e.audioPlayer.src){const e=sessionStorage.getItem("currentSongName");if(e){const n=a.findIndex((t=>t.name===e||t.name.includes(e)||e.includes(t.name)));-1!==n&&(t=n)}b(),E()}}}if((!sessionStorage.getItem("qualityUserAction")||"true"!==sessionStorage.getItem("qualityUserAction"))&&(b(),E(),window.scrollTo({top:0,behavior:"smooth"}),a.length>0)){const o=e.audioPlayer.src;a.some((e=>e.src===o))||(t=0,S(a[t]),n&&e.audioPlayer.addEventListener("loadedmetadata",(function t(){x(),e.audioPlayer.removeEventListener("loadedmetadata",t)})))}}}function b(){const t=e.songsListDesktop,n=e.songsListMobile;t&&n?(t.style.animation="none",n.style.animation="none",t.offsetWidth,n.offsetWidth,t.style.animation="slideInUp 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275)",n.style.animation="slideInUp 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275)"):console.warn("Song list elements not found for animation")}function E(){if(!e.songsListDesktop||!e.songsListMobile)return void console.warn("Song list elements not found for rendering");if(e.songsListDesktop.innerHTML="",e.songsListMobile.innerHTML="",0===a.length){const t=document.createElement("div");return t.className="song-item",t.innerHTML='\n                        <div class="song-details">\n                            <div class="song-name">暂无歌曲</div>\n                        </div>\n                    ',e.songsListDesktop.appendChild(t),void e.songsListMobile.appendChild(t.cloneNode(!0))}const n=document.createDocumentFragment(),o=document.createDocumentFragment();a.forEach(((s,a)=>{const i=sessionStorage.getItem("currentSongName");let r,l=!1;l="true"===sessionStorage.getItem("qualityUserAction")&&i?s.name===i||s.name.includes(i)||i.includes(s.name):e.audioPlayer.src.includes(s.src),l&&(t=a);r=`${u()} - ${d()}`;const c="flac"===(new URLSearchParams(window.location.search).get("quality")||"mp3")?"FLAC":"MP3",m=`\n                        <div class="song-number">${a+1}</div>\n                        <div class="song-details">\n                            <div class="song-name">${s.name}</div>\n                            <div class="song-artist-name">${r}</div>\n                        </div>\n                        <div class="quality-badge">${c}</div>\n                    `,y=document.createElement("div");y.className="song-item",y.dataset.index=a,l&&y.classList.add("active"),y.innerHTML=m,n.appendChild(y);const g=y.cloneNode(!0);o.appendChild(g)})),e.songsListDesktop.appendChild(n),e.songsListMobile.appendChild(o),function(){const t=e.songsListDesktop.querySelectorAll(".song-item"),n=e.songsListMobile.querySelectorAll(".song-item");[...t,...n].forEach(((e,t)=>{e.style.animation="none",e.style.opacity="0",e.offsetWidth,e.style.animation=`fadeInRight 0.5s ease-out ${.05*t}s both`}))}()}function w(){if(e.songsListDesktop.innerHTML="",e.songsListMobile.innerHTML="",0===a.length){const t=document.createElement("div");return t.className="song-item",t.innerHTML='\n                        <div class="song-details">\n                            <div class="song-name">暂无歌曲</div>\n                        </div>\n                    ',e.songsListDesktop.appendChild(t),void e.songsListMobile.appendChild(t.cloneNode(!0))}const n=document.createDocumentFragment(),o=document.createDocumentFragment();a.forEach(((s,a)=>{const i=sessionStorage.getItem("currentSongName");let r,l=!1;l="true"===sessionStorage.getItem("qualityUserAction")&&i?s.name===i||s.name.includes(i)||i.includes(s.name):e.audioPlayer.src.includes(s.src),l&&(t=a);r=`${u()} - ${d()}`;const c="flac"===(new URLSearchParams(window.location.search).get("quality")||"mp3")?"FLAC":"MP3",m=`\n                        <div class="song-number">${a+1}</div>\n                        <div class="song-details">\n                            <div class="song-name">${s.name}</div>\n                            <div class="song-artist-name">${r}</div>\n                        </div>\n                        <div class="quality-badge">${c}</div>\n                    `,y=document.createElement("div");y.className="song-item",y.dataset.index=a,l&&y.classList.add("active"),y.innerHTML=m,n.appendChild(y);const g=y.cloneNode(!0);o.appendChild(g)})),e.songsListDesktop.appendChild(n),e.songsListMobile.appendChild(o)}function P(o){const s=o.target.closest(".song-item");if(!s)return;const i=parseInt(s.dataset.index);if(isNaN(i)||i<0||i>=a.length)return;t=i;const r=new URLSearchParams(window.location.search).get("quality")||"mp3",l=a[t],c=l.src.startsWith("http")?l.src:`${window.location.origin}/${l.src}`,d=new URL(c);d.searchParams.has("quality")||d.searchParams.set("quality",r);const u={...l,src:d.toString()},m=new URL(e.audioPlayer.src,window.location.origin);if(e.audioPlayer.src&&m.pathname===d.pathname&&m.search===d.search&&!n)return void x();C(),S(u);const y=function(){I(),x(),e.audioPlayer.removeEventListener("loadedmetadata",y),e.audioPlayer.removeEventListener("error",g)},g=function(){I(),B("音频加载失败，请检查网络连接"),e.audioPlayer.removeEventListener("loadedmetadata",y),e.audioPlayer.removeEventListener("error",g)};e.audioPlayer.addEventListener("loadedmetadata",y),e.audioPlayer.addEventListener("error",g)}function C(){if(e.playPauseBtn&&e.playIcon&&e.pauseIcon){if(!e.playPauseBtn.classList.contains("loading")&&(e.playPauseBtn.classList.add("loading"),e.playIcon.style.display="none",e.pauseIcon.style.display="none",!e.playPauseBtn.querySelector(".loading-indicator"))){const t=document.createElement("div");t.className="loading-indicator",t.innerHTML='<svg class="svg-icon" style="animation: spin 1s linear infinite;"><use href="#icon-play"></use></svg>',e.playPauseBtn.appendChild(t)}}else console.warn("Play button elements not found")}function I(){if(!e.playPauseBtn||!e.playIcon||!e.pauseIcon)return void console.warn("Play button elements not found for hiding loading state");e.playPauseBtn.classList.remove("loading");e.playPauseBtn.querySelectorAll(".loading-indicator").forEach((e=>e.remove())),n?(e.playIcon.style.display="none",e.pauseIcon.style.display="block"):(e.playIcon.style.display="block",e.pauseIcon.style.display="none")}function B(e){const t=document.createElement("div");t.className="error-toast",t.innerHTML=`\n                    <i class="fa fa-exclamation-circle"></i>\n                    <span>${e}</span>\n                `,document.body.appendChild(t),setTimeout((()=>{t.classList.add("fade-out"),setTimeout((()=>{t.parentNode&&t.parentNode.removeChild(t)}),300)}),3e3)}function S(t){if(!t)return;const o=new URL(e.audioPlayer.src,window.location.origin),a=new URL(t.src,window.location.origin);if(e.audioPlayer.src&&o.pathname===a.pathname&&o.search===a.search)return console.log("歌曲已在播放器中，跳过重复加载:",t.name),e.songTitleElement.textContent=t.name,T(),void(n||x());e.songTitleElement.textContent=t.name;const i=u(),r=d();e.songArtistElement.textContent=`${i} - ${r}`;const l=document.getElementById("lyrics-song-title"),m=document.getElementById("lyrics-song-artist");l&&(l.textContent=t.name),m&&(m.textContent=`${i} - ${r}`);let p="img/1.jpg";if(s&&window.musicAlbums){const e=c();if(e&&e.cover)p=e.cover;else for(const e of window.musicAlbums)if(e.songs&&e.songs.some((e=>e.src===t.src))&&e.cover){p=e.cover;break}}if(e.coverImage){const t=p;v===t&&"img/1.jpg"!==t&&"img/default.jpg"!==t?console.log("封面相同，跳过重复加载:",t):"img/default.jpg"!==p?(e.coverImage.removeAttribute("src"),e.coverImage.setAttribute("data-src",p),!function(e){const t=e.getBoundingClientRect();return t.top>=0&&t.left>=0&&t.bottom<=(window.innerHeight||document.documentElement.clientHeight)&&t.right<=(window.innerWidth||document.documentElement.clientWidth)}(e.coverImage)&&window.imageObserver?window.imageObserver.observe(e.coverImage):(e.coverImage.src=p,e.coverImage.removeAttribute("data-src"),e.coverImage.onload=()=>{e.coverImage.style.opacity="0",e.coverImage.style.transition="opacity 0.3s",e.coverImage.classList.add("lazy-loaded"),requestAnimationFrame((()=>{e.coverImage.style.opacity="1"})),v=p})):(e.coverImage.src=p,v=p)}else console.warn("Cover image element not found");if(e.audioPlayer){const n=new URLSearchParams(window.location.search).get("quality")||"mp3",o=t.src.startsWith("http")?t.src:new URL(t.src,window.location.origin).href,s=new URL(o);s.searchParams.has("quality")||s.searchParams.set("quality",n),e.audioPlayer.src=s.toString(),T(),z();const a=document.getElementById("lyrics-page");a&&a.classList.contains("active")&&W(t),g&&e.audioPlayer.removeEventListener("error",g),y&&e.audioPlayer.removeEventListener("loadedmetadata",y),g=k,e.audioPlayer.addEventListener("error",g),y=function(){!function(){if(!e.audioPlayer||!e.totalTimeElement)return void console.warn("更新总时长所需的关键元素未找到");const t=e.audioPlayer.duration;t&&!isNaN(t)&&(e.totalTimeElement.textContent=R(t))}()},e.audioPlayer.addEventListener("loadedmetadata",y)}else console.warn("Audio player element not found"),I()}function k(e){I();const t=e.target.error;let n="音频加载失败";switch(t.code){case t.MEDIA_ERR_ABORTED:n="音频加载被中止";break;case t.MEDIA_ERR_NETWORK:n="网络错误，音频加载失败";break;case t.MEDIA_ERR_DECODE:n="音频解码失败";break;case t.MEDIA_ERR_SRC_NOT_SUPPORTED:n="音频格式不支持";break;default:n="音频加载失败，请检查网络连接"}B(n),console.error("音频加载错误:",t)}function T(){document.querySelectorAll(".song-item.active").forEach((e=>e.classList.remove("active")));document.querySelectorAll(`.song-item[data-index="${t}"]`).forEach((e=>e.classList.add("active")))}function M(){e.playIcon&&e.pauseIcon?n?(e.playIcon.style.display="none",e.pauseIcon.style.display="block",e.albumCover&&e.albumCover.classList.add("playing")):(e.playIcon.style.display="block",e.pauseIcon.style.display="none",e.albumCover&&e.albumCover.classList.remove("playing")):console.warn("播放/暂停图标元素未找到")}function x(){if(0===a.length)return;if(C(),!(e.audioPlayer&&e.playIcon&&e.pauseIcon&&e.albumCover))return console.warn("播放所需的关键元素未找到"),void I();const t=e.audioPlayer.play();if(void 0!==t)t.then((()=>{I(),n=!0,M(),m()})).catch((e=>{I(),console.error("播放失败:",e);let t="播放失败";t="NotAllowedError"===e.name?"浏览器阻止了自动播放，请点击播放按钮":"NotSupportedError"===e.name?"音频格式不支持":"播放失败，请重试",B(t)}));else try{e.audioPlayer.play(),n=!0,M(),I(),m()}catch(e){I(),console.error("播放失败:",e),B("播放失败，请重试")}}function q(){if(0!==a.length){if(2===o){const e=Math.floor(Math.random()*a.length);t=e}else if(3===o)t=(t+1)%a.length;else if(0===o)t=(t+1)%a.length;else{if(!(t<a.length-1))return;t++}S(a[t]),setTimeout((()=>{if(e.audioPlayer&&e.audioPlayer.readyState>=2)x();else{const t=function(){x(),e.audioPlayer.removeEventListener("loadedmetadata",t)};e.audioPlayer.addEventListener("loadedmetadata",t)}}),100)}}function A(){if(0!==a.length){if(2===o){const e=Math.floor(Math.random()*a.length);t=e}else if(3===o)t=(t-1+a.length)%a.length;else if(0===o)t=(t-1+a.length)%a.length;else{if(!(t>0))return;t--}S(a[t]),setTimeout((()=>{if(e.audioPlayer&&e.audioPlayer.readyState>=2)x();else{const t=function(){x(),e.audioPlayer.removeEventListener("loadedmetadata",t)};e.audioPlayer.addEventListener("loadedmetadata",t)}}),100)}}function H(){if(!e.audioPlayer||!e.progress)return void console.warn("更新进度所需的关键元素未找到");const{duration:t,currentTime:n}=e.audioPlayer;if(t&&!isNaN(t)){const o=n/t*100;e.progress.style.width=`${o}%`}!function(){if(!e.audioPlayer||!e.currentTimeElement)return void console.warn("更新当前时间所需的关键元素未找到");const t=e.audioPlayer.currentTime;e.currentTimeElement.textContent=R(t)}()}function R(e){const t=Math.floor(e/60),n=Math.floor(e%60);return`${t.toString().padStart(2,"0")}:${n.toString().padStart(2,"0")}`}function $(t){if(!e.progressBar||!e.audioPlayer)return void console.warn("设置进度条所需的关键元素未找到");const n=e.progressBar.clientWidth,o=e.progressBar.getBoundingClientRect(),s=t.clientX-o.left,a=e.audioPlayer.duration;if(a){const t=s/n*a;e.audioPlayer.currentTime=t}}function N(){if(e.modeIcon&&e.playModeBtn)switch(o=0===o?3:3===o?2:2===o?1:0,o){case 0:e.modeIcon.innerHTML='<path d="M8 20V21.9324C8 22.2086 7.77614 22.4324 7.5 22.4324C7.38303 22.4324 7.26977 22.3914 7.17991 22.3165L3.06093 18.8841C2.84879 18.7073 2.82013 18.392 2.99691 18.1799C3.09191 18.0659 3.23264 18 3.38103 18L18 18C19.1046 18 20 17.1045 20 16V7.99997H22V16C22 18.2091 20.2091 20 18 20H8ZM16 3.99997V2.0675C16 1.79136 16.2239 1.5675 16.5 1.5675C16.617 1.5675 16.7302 1.60851 16.8201 1.68339L20.9391 5.11587C21.1512 5.29266 21.1799 5.60794 21.0031 5.82008C20.9081 5.93407 20.7674 5.99998 20.619 5.99998L6 5.99997C4.89543 5.99997 4 6.8954 4 7.99997V16H2V7.99997C2 5.79083 3.79086 3.99997 6 3.99997H16Z"/>',e.playModeBtn.style.backgroundColor="transparent",e.playModeBtn.style.color="var(--text-secondary)";break;case 1:e.modeIcon.innerHTML='<path d="M17 3.99998V2.0675C17 1.79136 17.2239 1.5675 17.5 1.5675C17.617 1.5675 17.7302 1.60851 17.8201 1.68339L21.9391 5.11587C22.1512 5.29266 22.1799 5.60794 22.0031 5.82008C21.9081 5.93407 21.7674 5.99998 21.619 5.99998H2V3.99998H17ZM2 18H22V20H2V18ZM2 11H22V13H2V11Z"/>',e.playModeBtn.style.backgroundColor="transparent",e.playModeBtn.style.color="var(--text-secondary)";const t=e.playModeBtn.querySelector(".loop-dot");t&&t.remove();break;case 2:e.modeIcon.innerHTML='<path d="M18 17.8832V16L23 19L18 22V19.9095C14.9224 19.4698 12.2513 17.4584 11.0029 14.5453L11 14.5386L10.9971 14.5453C9.57893 17.8544 6.32508 20 2.72483 20H2V18H2.72483C5.52503 18 8.05579 16.3312 9.15885 13.7574L9.91203 12L9.15885 10.2426C8.05579 7.66878 5.52503 6 2.72483 6H2V4H2.72483C6.32508 4 9.57893 6.14557 10.9971 9.45473L11 9.46141L11.0029 9.45473C12.2513 6.5416 14.9224 4.53022 18 4.09051V2L23 5L18 8V6.11684C15.7266 6.53763 13.7737 8.0667 12.8412 10.2426L12.088 12L12.8412 13.7574C13.7737 15.9333 15.7266 17.4624 18 17.8832Z"/>',e.playModeBtn.style.backgroundColor="transparent",e.playModeBtn.style.color="var(--text-secondary)";break;case 3:e.modeIcon.innerHTML='<path d="M8 20V21.9325C8 22.2086 7.77614 22.4325 7.5 22.4325C7.38303 22.4325 7.26977 22.3915 7.17991 22.3166L3.06093 18.8841C2.84879 18.7073 2.82013 18.392 2.99691 18.1799C3.09191 18.0659 3.23264 18 3.38103 18L18 18C19.1046 18 20 17.1046 20 16V8H22V16C22 18.2091 20.2091 20 18 20H8ZM16 2.0675C16 1.79136 16.2239 1.5675 16.5 1.5675C16.617 1.5675 16.7302 1.60851 16.8201 1.68339L20.9391 5.11587C21.1512 5.29266 21.1799 5.60794 21.0031 5.82008C20.9081 5.93407 20.7674 5.99998 20.619 5.99998L6 6C4.89543 6 4 6.89543 4 8V16H2V8C2 5.79086 3.79086 4 6 4H16V2.0675ZM11 8H13V16H11V10H9V9L11 8Z"/>',e.playModeBtn.style.backgroundColor="transparent",e.playModeBtn.style.color="var(--text-secondary)"}else console.warn("切换播放模式所需的关键元素未找到")}function U(){const e=document.querySelector(".cloud-qr-modal");e&&document.body.removeChild(e);const t=document.createElement("div");t.className="cloud-qr-modal",t.innerHTML='\n                    <div class="qr-modal-content">\n                        <div class="qr-modal-header">\n                            <h3>上传歌曲至网易云盘</h3>\n                            <button class="qr-modal-close">&times;</button>\n                        </div>\n                        <div class="qr-modal-body">\n                            <img src="img/xcx.jpg" alt="云盘二维码" class="qr-code-image">\n                            <p>扫码使用小程序上传歌曲</p>\n                            <p><a href="https://mp.weixin.qq.com/s/pHsFSPTn3Cd7MXV81J4NHg" target="_blank" class="guide-button">使用指南</a></p>\n                        </div>\n                    </div>\n                ',document.body.appendChild(t),setTimeout((()=>{t.style.opacity="1",t.style.visibility="visible"}),10);const n=t.querySelector(".qr-modal-close");n&&n.addEventListener("click",(function(){const e=t.querySelector(".qr-modal-content");e&&(e.style.animation="modalBounceOut 0.4s ease-in forwards"),setTimeout((()=>{document.body.contains(t)&&document.body.removeChild(t)}),400)})),t.addEventListener("click",(function(e){if(e.target===t){const e=t.querySelector(".qr-modal-content");e&&(e.style.animation="modalBounceOut 0.4s ease-in forwards"),setTimeout((()=>{document.body.contains(t)&&document.body.removeChild(t)}),400)}}))}e.audioPlayer?e.audioPlayer.volume=.8:console.warn("Audio player element not found");const V={playPause:null,prev:null,next:null,playMode:null,cloud:null,timeupdate:null,progressClick:null,ended:null,albumCover:null,songClickDesktop:null,songClickMobile:null,lyricsToggle:null};function D(){const n=document.getElementById("cover-page"),o=document.getElementById("lyrics-page");if(n&&o)if(n.classList.contains("active")){n.classList.remove("active"),o.classList.add("active");let s=null;if(e.audioPlayer&&e.audioPlayer.src){const t=e.audioPlayer.src;if(s=a.find((e=>{const n=e.src.startsWith("http")?e.src:new URL(e.src,window.location.origin).href;return t===n||t.includes(e.src+"?")})),!s)try{const e=new URL(t);s=a.find((t=>{const n=t.src.startsWith("http")?t.src:new URL(t.src,window.location.origin).href,o=new URL(n);return e.pathname===o.pathname&&e.searchParams.get("quality")===o.searchParams.get("quality")}))}catch(e){console.warn("URL解析失败:",e)}}!s&&t>=0&&a[t]&&(s=a[t]),s?i===s.src||W(s):F("请先播放一首歌曲")}else o.classList.remove("active"),n.classList.add("active");else console.error("未找到封面或歌词页面元素")}function W(e){e&&e.lrc?i!==e.src&&(e.lrc.endsWith(".lrc")||e.lrc.endsWith(".txt")?fetch(e.lrc).then((e=>{if(!e.ok)throw new Error("歌词加载失败: "+e.status);return e.text()})).then((t=>{i=e.src,j(t,e.src)})).catch((t=>{console.error("加载歌词失败:",t),F("歌词加载失败: "+t.message,e.src)})):(i=e.src,j(e.lrc,e.src))):F("暂无歌词",e?e.src:null)}function j(e,t){if(!e)return void F("暂无歌词",t);const n=e.split("\n"),o=[];for(const e of n){const t=e.trim();if(!t)continue;if(t.match(/^\[(id|ti|ar|al|by|offset|length|re|ve|au|len|lg|language|ck|km|wm):.*\]$/))continue;const n=t.match(/^\[(\d{2}):(\d{2})(?:\.(\d{2}))?\]/);if(n){const e=60*parseInt(n[1])+parseInt(n[2])+(n[3]?parseInt(n[3]):0)/100;let s=t.replace(/^\[\d{2}:\d{2}(?:\.\d{2})?\]/,"");s=s.replace(/<\d{2}:\d{2}(?:\.\d{2})?>/g,"").trim(),s&&o.push({time:e,text:s})}else t.startsWith("[")||o.push({time:-1,text:t})}F(o,t)}function F(t,o){const s=document.getElementById("lyrics-content");if(s)if(s.innerHTML="",o&&s.setAttribute("data-song-src",o),"string"==typeof t){const e=document.createElement("p");e.textContent=t,e.className="lyrics-line",s.appendChild(e)}else Array.isArray(t)&&(t.forEach(((e,t)=>{const n=document.createElement("p");n.textContent=e.text,n.className="lyrics-line",n.classList.add("next"),n.setAttribute("data-time",e.time),n.setAttribute("data-index",t),s.appendChild(n)})),function(t){if(!e.audioPlayer||!t.length)return;const o=document.getElementById("lyrics-content");if(!o)return;o.addEventListener("scroll",(function(){r=!0,l&&clearTimeout(l),l=setTimeout((()=>{r=!1}),3e3)})),o.addEventListener("click",(function(t){t.stopPropagation();const o=document.getElementById("lyrics-page");if(!o||!o.classList.contains("active"))return;const s=t.target.closest(".lyrics-line");if(s){r=!1,l&&(clearTimeout(l),l=null);const t=s.getAttribute("data-time");t&&e.audioPlayer&&"-1"!==t&&(e.audioPlayer.currentTime=parseFloat(t),e.audioPlayer.paused&&e.audioPlayer.play().then((()=>{n=!0,M()})).catch((e=>{console.error("播放失败:",e),n=!1,M()})))}})),V.lyricsSync&&e.audioPlayer.removeEventListener("timeupdate",V.lyricsSync);V.lyricsSync=function(){if(r)return;const n=e.audioPlayer.currentTime;if(!o)return;let s=-1;for(let e=0;e<t.length;e++)if(-1!==t[e].time){if(!(t[e].time<=n))break;s=e}o.querySelectorAll(".lyrics-line").forEach(((e,t)=>{if(e.classList.remove("active","past","next","past-1","past-2","past-3","next-1","next-2","next-3"),t===s){e.classList.add("active");const t=e.offsetTop-o.clientHeight/2+e.offsetHeight/2;o.scrollTo({top:t,behavior:"smooth"})}else if(t<s){const n=s-t;n<=3?e.classList.add(`past-${n}`):e.classList.add("past")}else{const n=t-s;n<=3?e.classList.add(`next-${n}`):e.classList.add("next")}}))},e.audioPlayer.addEventListener("timeupdate",V.lyricsSync),V.lyricsSync()}(t))}function z(){if(!("mediaSession"in navigator))return;const e=a[t];if(!e)return;const n=d(),o=`${e.name}-${n}-${s}`;if(p===o)return;p=o;let i="img/1.jpg";if(e.cover)i=e.cover;else if(s&&window.musicAlbums){const e=c();e&&e.cover&&(i=e.cover)}if(!i.startsWith("http")&&!i.startsWith("//")){i=window.location.origin+window.location.pathname.substring(0,window.location.pathname.lastIndexOf("/"))+"/"+i}const r=new MediaMetadata({title:e.name||"未知歌曲",artist:n||"未知艺术家",album:e.album||s||"未知专辑",artwork:[{src:i,sizes:"96x96",type:"image/jpeg"},{src:i,sizes:"128x128",type:"image/jpeg"},{src:i,sizes:"192x192",type:"image/jpeg"},{src:i,sizes:"256x256",type:"image/jpeg"},{src:i,sizes:"384x384",type:"image/jpeg"},{src:i,sizes:"512x512",type:"image/jpeg"}]});navigator.mediaSession.metadata=r}function O(e,t){return"flac"!==t||!["网易云歌单","工体东路没有人","108个关键词"].includes(e)}function Q(){const e=document.getElementById("quality-modal");if(e){e.classList.add("active");const n=new URLSearchParams(window.location.search).get("quality")||"mp3",o=document.getElementById("quality-hq"),i=document.getElementById("quality-sq");o.classList.remove("selected","unavailable","current"),i.classList.remove("selected","unavailable","current");if(a[t]&&s&&window.musicAlbums){const e=c();if(e){const t=O(e.name,"flac");"mp3"!==n||t||i.classList.add("unavailable");const s=O(e.name,"mp3");"flac"!==n||s||o.classList.add("unavailable")}}"mp3"===n?o.classList.add("selected","current"):"flac"===n&&i.classList.add("selected","current");const r=document.getElementById("quality-modal-close");r&&(r.onclick=function(){e.classList.remove("active")}),e.onclick=function(t){t.target===e&&e.classList.remove("active")},o&&(o.onclick=function(){if(!this.classList.contains("current"))if(this.classList.contains("unavailable")){const e=c();X(`专辑"${e?e.name:"当前专辑"}"没有HQ音质版本`)}else Z("mp3"),e.classList.remove("active")}),i&&(i.onclick=function(){if(!this.classList.contains("current"))if(this.classList.contains("unavailable")){const e=c();X(`专辑"${e?e.name:"当前专辑"}"没有SQ音质版本`)}else Z("flac"),e.classList.remove("active")})}}function Z(o){const i=a[t];if(!i)return;const r=i.name,l=(d(),n),m=e.audioPlayer.currentTime;sessionStorage.setItem("qualityUserAction","true"),sessionStorage.setItem("currentSongName",r),sessionStorage.setItem("wasPlaying",l.toString()),sessionStorage.setItem("currentTime",m.toString());const y="mp3"===o?"mp3list-script":"flaclist-script",g="mp3"===o?"js/mp3list.js?t=2025102101":"js/flaclist.js?t=2025102101",p=document.getElementById("mp3list-script")||document.getElementById("flaclist-script"),v=document.getElementById("otherlist-script");p&&p.remove(),v&&v.remove();const f=document.createElement("script");if(f.id=y,f.src=g,"mp3"===o){const e=document.createElement("script");e.id="otherlist-script",e.src="js/other.list?t="+Date.now(),e.onload=function(){document.head.appendChild(f)},document.head.appendChild(e)}else document.head.appendChild(f);f.onload=function(){const n=new URL(window.location);n.searchParams.set("quality",o),window.history.pushState({},"",n),h();const i=sessionStorage.getItem("currentSongName"),r="true"===sessionStorage.getItem("wasPlaying"),l=parseFloat(sessionStorage.getItem("currentTime")||"0");setTimeout((()=>{if(i&&a.length>0){let n=null,d=null,m=-1;const y=c();if(y&&y.songs){const e=y.songs.findIndex((e=>e.name===i||e.name.includes(i)||i.includes(e.name)));-1!==e&&(n=y.songs[e],d=s,m=e)}if(n&&null!==d){sessionStorage.setItem("qualityUserAction","true");new URLSearchParams(window.location.search).get("quality");L(d),setTimeout((()=>{const e=c();e&&e.songs&&(a=[...e.songs],E())}),100),setTimeout((()=>{const n=new URLSearchParams(window.location.search).get("quality")||"mp3",o=c();if(o&&o.songs&&o.songs[m]){t=m;const s=o.songs[m],a=s.src.startsWith("http")?s.src:`${window.location.origin}/${s.src}`,i=new URL(a);i.searchParams.has("quality")||i.searchParams.set("quality",n);const c={...s,src:i.toString()};if(e.audioPlayer&&(e.audioPlayer.src=c.src,e.audioPlayer.load()),r){const t=()=>{e.audioPlayer&&e.audioPlayer.readyState>=2?(e.audioPlayer.currentTime=l,x()):setTimeout(t,100)};setTimeout(t,100)}else{const t=()=>{e.audioPlayer&&e.audioPlayer.readyState>=2?e.audioPlayer.currentTime=l:setTimeout(t,100)};setTimeout(t,100)}}}),500)}else{sessionStorage.setItem("songNotFound","true"),setTimeout((()=>{X(`专辑"${u()}"中没有"${i}"的${"flac"===o?"SQ":"HQ"}音质版本`)}),1e3);const n="flac"===o?"mp3":"flac",a=new URL(window.location);a.searchParams.set("quality",n),window.history.pushState({},"",a);const d="mp3"===n?"mp3list-script":"flaclist-script",m="mp3"===n?"js/mp3list.js?t=2025102101":"js/flaclist.js?t=2025102101",y=document.getElementById("mp3list-script")||document.getElementById("flaclist-script");y&&y.remove();const g=document.createElement("script");g.id=d,g.src=m,g.onload=function(){h(),setTimeout((()=>{const n=c();n&&n.songs&&(L(s),setTimeout((()=>{const o=n.songs.findIndex((e=>e.name===i||e.name.includes(i)||i.includes(e.name)));if(-1!==o)if(t=o,S(n.songs[o]),r){const t=()=>{e.audioPlayer&&e.audioPlayer.readyState>=2?(e.audioPlayer.currentTime=l,x()):setTimeout(t,100)};setTimeout(t,100)}else{const t=()=>{e.audioPlayer&&e.audioPlayer.readyState>=2?e.audioPlayer.currentTime=l:setTimeout(t,100)};setTimeout(t,100)}}),300)),_()}),300)},document.head.appendChild(g)}}else console.log("未找到保存的播放状态，等待用户手动选择专辑");_(),sessionStorage.removeItem("currentSongName"),sessionStorage.removeItem("wasPlaying"),sessionStorage.removeItem("currentTime"),sessionStorage.removeItem("qualityUserAction")}),300)},document.head.appendChild(f)}function _(){const e=new URLSearchParams(window.location.search).get("quality")||"mp3",t="true"===sessionStorage.getItem("qualityUserAction"),n="true"===sessionStorage.getItem("songNotFound");sessionStorage.removeItem("qualityUserAction"),sessionStorage.removeItem("songNotFound");const o=document.getElementById("quality-indicator"),s=document.getElementById("mobile-quality-indicator");"flac"===e?(o&&(o.classList.add("active"),o.classList.remove("hq-active"),o.textContent="SQ"),s&&(s.classList.add("active"),s.classList.remove("hq-active"),s.textContent="SQ"),console.log("已切换至无损SQ音质歌单"),t&&!n&&X("已切换为无损SQ音质 歌单已更新")):(o&&(o.classList.remove("active"),o.classList.add("hq-active"),o.textContent="HQ"),s&&(s.classList.remove("active"),s.classList.add("hq-active"),s.textContent="HQ"),console.log("已切换至极高HQ音质歌单"),t&&!n&&X("已切换为极高HQ音质 歌单已更新"))}function X(e){const t=document.createElement("div");t.className="notification",t.textContent=e,t.style.position="fixed",t.style.top="50%",t.style.left="50%",t.style.transform="translate(-50%, -50%)",t.style.backgroundColor="var(--bg-card)",t.style.color="var(--primary)",t.style.padding="12px 24px",t.style.borderRadius="var(--radius-md)",t.style.zIndex="10000",t.style.boxShadow="var(--shadow)",t.style.opacity="0",t.style.transition="opacity 0.5s ease, transform 0.5s ease",t.style.fontSize="16px",t.style.fontWeight="500",t.style.whiteSpace="nowrap",t.style.border="1px solid var(--primary)",t.style.backdropFilter="blur(10px)",t.style.webkitBackdropFilter="blur(10px)",document.body.appendChild(t),setTimeout((()=>{t.style.opacity="1",t.style.transform="translate(-50%, -50%) scale(1)"}),100),setTimeout((()=>{t.style.opacity="0",t.style.transform="translate(-50%, -50%) scale(0.95)",setTimeout((()=>{document.body.removeChild(t)}),500)}),5e3)}window.addEventListener("beforeunload",(function(){V.playPause&&e.playPauseBtn.removeEventListener("click",V.playPause),V.prev&&e.prevBtn.removeEventListener("click",V.prev),V.next&&e.nextBtn.removeEventListener("click",V.next),V.playMode&&e.playModeBtn.removeEventListener("click",V.playMode),V.cloud&&e.cloudBtn.removeEventListener("click",V.cloud),V.timeupdate&&e.audioPlayer.removeEventListener("timeupdate",V.timeupdate),V.progressClick&&e.progressBar.removeEventListener("click",V.progressClick),V.ended&&e.audioPlayer.removeEventListener("ended",V.ended),V.albumCover&&e.albumCover.removeEventListener("click",V.albumCover),V.lyricsPage&&e.lyricsPage.removeEventListener("click",V.lyricsPage),V.songClickDesktop&&e.songsListDesktop.removeEventListener("click",V.songClickDesktop),V.songClickMobile&&e.songsListMobile.removeEventListener("click",V.songClickMobile)})),h(),function(){if(!e.mobileSongsContainer)return;let t=!1,n=!1,o=null;const s=(a=function(){n||(t=!t,n=!0,requestAnimationFrame((()=>{t?e.mobileSongsContainer.classList.add("collapsed"):e.mobileSongsContainer.classList.remove("collapsed"),setTimeout((()=>{n=!1}),320)})))},i=30,function(){const e=this,t=arguments;clearTimeout(o),o=setTimeout((()=>{a.apply(e,t)}),i)});var a,i;e.mobileSongsContainer.querySelector(".songs-header").addEventListener("click",(function(e){e.target.closest(".quality-indicator")||s()}))}(),function(){if(!e.progressBar||!e.audioPlayer)return void console.warn("初始化进度条拖拽所需的关键元素未找到");let t=!1;e.progressBar.addEventListener("mousedown",(function(n){t=!0,e.progressBar.classList.add("dragging"),$(n)})),document.addEventListener("mousemove",(function(n){if(t){const t=e.progressBar.clientWidth,o=e.progressBar.getBoundingClientRect(),s=n.clientX-o.left,a=e.audioPlayer.duration;if(a){const n=Math.max(0,Math.min(t,s))/t*a;e.audioPlayer.currentTime=n}}})),document.addEventListener("mouseup",(function(){t&&(t=!1,e.progressBar.classList.remove("dragging"))})),e.progressBar.addEventListener("touchstart",(function(n){t=!0;const o=n.touches[0],s=e.progressBar.getBoundingClientRect(),a=o.clientX-s.left,i=e.progressBar.clientWidth,r=e.audioPlayer.duration;if(r){const t=Math.max(0,Math.min(i,a))/i*r;e.audioPlayer.currentTime=t}})),document.addEventListener("touchmove",(function(n){if(t){const t=n.touches[0],o=e.progressBar.getBoundingClientRect(),s=t.clientX-o.left,a=e.progressBar.clientWidth,i=e.audioPlayer.duration;if(i){const t=Math.max(0,Math.min(a,s))/a*i;e.audioPlayer.currentTime=t}}})),document.addEventListener("touchend",(function(){t&&(t=!1,e.progressBar.classList.remove("dragging"))}))}(),e.backToTopBtn&&(window.addEventListener("scroll",(function(){window.scrollY>300?e.backToTopBtn.classList.add("visible"):e.backToTopBtn.classList.remove("visible")})),e.backToTopBtn.addEventListener("click",(function(){window.scrollTo({top:0,behavior:"smooth"})}))),o=0,e.modeIcon&&e.playModeBtn&&(e.modeIcon.innerHTML='<path d="M8 20V21.9324C8 22.2086 7.77614 22.4324 7.5 22.4324C7.38303 22.4324 7.26977 22.3914 7.17991 22.3165L3.06093 18.8841C2.84879 18.7073 2.82013 18.392 2.99691 18.1799C3.09191 18.0659 3.23264 18 3.38103 18L18 18C19.1046 18 20 17.1045 20 16V7.99997H22V16C22 18.2091 20.2091 20 18 20H8ZM16 3.99997V2.0675C16 1.79136 16.2239 1.5675 16.5 1.5675C16.617 1.5675 16.7302 1.60851 16.8201 1.68339L20.9391 5.11587C21.1512 5.29266 21.1799 5.60794 21.0031 5.82008C20.9081 5.93407 20.7674 5.99998 20.619 5.99998L6 5.99997C4.89543 5.99997 4 6.8954 4 7.99997V16H2V7.99997C2 5.79083 3.79086 3.99997 6 3.99997H16Z"/>',e.playModeBtn.style.backgroundColor="transparent",e.playModeBtn.style.color="var(--text-secondary)"),w(),window.togglePage=D,m=function(){"mediaSession"in navigator&&(navigator.mediaSession.playbackState=n?"playing":"paused")},"mediaSession"in navigator?("mediaSession"in navigator&&(navigator.mediaSession.setActionHandler("play",(function(){e.audioPlayer.paused&&(e.audioPlayer.play(),n=!0,M(),z())})),navigator.mediaSession.setActionHandler("pause",(function(){e.audioPlayer.paused||(e.audioPlayer.pause(),n=!1,M())})),navigator.mediaSession.setActionHandler("previoustrack",(function(){playPrevious()})),navigator.mediaSession.setActionHandler("nexttrack",(function(){playNext()})),navigator.mediaSession.setActionHandler("seekto",(function(t){t.fastSeek&&"fastSeek"in e.audioPlayer?e.audioPlayer.fastSeek(t.seekTime):e.audioPlayer.currentTime=t.seekTime})),navigator.mediaSession.setActionHandler("stop",(function(){e.audioPlayer.pause(),e.audioPlayer.currentTime=0,n=!1,M()}))),e.audioPlayer.addEventListener("play",(function(){n=!0,M(),m()})),e.audioPlayer.addEventListener("pause",(function(){n=!1,M(),m()})),e.audioPlayer.addEventListener("ended",m),e.audioPlayer.addEventListener("timeupdate",(function(){})),document.addEventListener("visibilitychange",(function(){document.hidden&&n&&z()})),console.log("MediaSession API 初始化完成")):console.log("当前浏览器不支持MediaSession API"),_(),function(){e.playPauseBtn&&(V.playPause=()=>{n?function(){if(e.audioPlayer&&e.playIcon&&e.pauseIcon&&e.albumCover)try{e.audioPlayer.pause(),n=!1,M(),e.playPauseBtn&&e.playPauseBtn.classList.remove("loading"),m()}catch(e){console.error("暂停失败:",e)}else console.warn("暂停所需的关键元素未找到")}():x()},e.playPauseBtn.addEventListener("click",V.playPause)),e.prevBtn&&(V.prev=A,e.prevBtn.addEventListener("click",V.prev)),e.nextBtn&&(V.next=q,e.nextBtn.addEventListener("click",V.next)),e.playModeBtn&&(V.playMode=N,e.playModeBtn.addEventListener("click",V.playMode),e.playModeBtn.addEventListener("mouseenter",(function(){this.style.background="rgba(212, 175, 55, 0.15)",this.style.color="var(--primary)",this.style.border="1px solid rgba(212, 175, 55, 0.4)",this.style.boxShadow="0 0 15px rgba(212, 175, 55, 0.3)",this.style.borderRadius="var(--radius-md)",this.style.transform="translateY(-2px)"})),e.playModeBtn.addEventListener("mouseleave",(function(){this.style.background="rgba(255, 255, 255, 0.05)",this.style.color="var(--text-secondary)",this.style.border="1px solid rgba(212, 175, 55, 0.2)",this.style.boxShadow="none",this.style.borderRadius="var(--radius-md)",this.style.transform="none"}))),e.cloudBtn&&(V.cloud=U,e.cloudBtn.addEventListener("click",V.cloud));const t=document.getElementById("quality-indicator");t&&(V.quality=Q,t.addEventListener("click",V.quality));const s=document.getElementById("mobile-quality-indicator");if(s&&(V.mobileQuality=Q,s.addEventListener("click",V.mobileQuality)),e.audioPlayer&&(V.timeupdate=H,e.audioPlayer.addEventListener("timeupdate",V.timeupdate),V.ended=function(){3===o?(e.audioPlayer.currentTime=0,x()):q(),setTimeout((()=>{z(),m()}),100)},e.audioPlayer.addEventListener("ended",V.ended)),e.progressBar&&(V.progressClick=$,e.progressBar.addEventListener("click",V.progressClick)),e.albumCover)V.albumCover=D,e.albumCover.addEventListener("click",V.albumCover),e.albumCover.style.cursor="pointer",e.albumCover.style.pointerEvents="auto";else{console.error("未找到专辑封面元素");const t=document.getElementById("album-cover");t?(e.albumCover=t,V.albumCover=D,e.albumCover.addEventListener("click",V.albumCover),e.albumCover.style.cursor="pointer",e.albumCover.style.pointerEvents="auto"):console.error("无法获取专辑封面元素")}e.lyricsPage?(V.lyricsPage=function(t){const n=t.target.closest(".lyrics-line"),o=t.target.closest("#lyrics-content");n||o||e.lyricsPage.classList.contains("active")&&D()},e.lyricsPage.addEventListener("click",V.lyricsPage)):console.error("未找到歌词页面元素"),e.songsListDesktop&&(V.songClickDesktop=P,e.songsListDesktop.addEventListener("click",V.songClickDesktop)),e.songsListMobile&&(V.songClickMobile=P,e.songsListMobile.addEventListener("click",V.songClickMobile))}(),_()}"loading"===document.readyState?document.addEventListener("DOMContentLoaded",initMusicPlayer):initMusicPlayer();
