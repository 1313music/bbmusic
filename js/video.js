window.addEventListener('DOMContentLoaded',function(){function loadScript(src,callback){const script=document.createElement('script');script.src=src;script.defer=true;script.onload=callback;document.body.appendChild(script)}loadScript('js/videoData.js?t=2025100101',function(){loadScript('lib/hls.min.js',function(){if(Hls.isSupported()){Hls.DefaultConfig.enableWorker=true;Hls.DefaultConfig.enableStreaming=true;Hls.DefaultConfig.maxBufferLength=30;Hls.DefaultConfig.maxMaxBufferLength=60;Hls.DefaultConfig.liveSyncDurationCount=3}loadScript('lib/DPlayer.min.js',initializeApp)})})});function initializeApp(){disableVideoContextMenu();const videoData=window.videoData||{};const categories=window.categories||[];let dp=null;let currentVideoUrl='';function initDPlayer(){if(dp)return dp;dp=new DPlayer({container:document.getElementById('dplayer-container'),live:false,autoplay:false,theme:'#d4af37',loop:false,lang:'zh-cn',hotkey:true,volume:0.7,playbackSpeed:[0.5,0.75,1,1.25,1.5,2],mutex:true,contextmenu:[],video:{url:'',pic:'https://v.1701701.xyz/img/bg.jpg'},errorHandler:function(error){console.error('DPlayer error:',error);showCompatibilityAlert('视频播放失败: '+error.message)},mobileControls:true,hideControlsAfter:1000,autoHide:true});disableVideoContextMenu();setTimeout(()=>{if(dp&&dp.controller){dp.controller.hide()}},1000);return dp}function disableVideoContextMenu(){setTimeout(()=>{const dplayerContainer=document.getElementById('dplayer-container');if(dplayerContainer){dplayerContainer.addEventListener('contextmenu',function(e){e.preventDefault();return false})}const videoElements=document.querySelectorAll('video');videoElements.forEach(video=>{video.addEventListener('contextmenu',function(e){e.preventDefault();return false});video.addEventListener('dragstart',function(e){e.preventDefault();return false})});document.addEventListener('contextmenu',function(e){if(e.target.tagName==='VIDEO'){e.preventDefault();return false}});document.addEventListener('dragstart',function(e){if(e.target.tagName==='VIDEO'){e.preventDefault();return false}})},500)}function initCategories(){const container=document.getElementById('categories-container');container.innerHTML='';categories.forEach(category=>{const btn=document.createElement('button');btn.className='category-btn';btn.dataset.category=category.id;const svgIcon=document.createElementNS('http://www.w3.org/2000/svg','svg');svgIcon.setAttribute('class','svg-icon');svgIcon.setAttribute('viewBox','0 0 24 24');const useElement=document.createElementNS('http://www.w3.org/2000/svg','use');useElement.setAttributeNS('http://www.w3.org/1999/xlink','href',category.icon);svgIcon.appendChild(useElement);btn.appendChild(svgIcon);const text=document.createTextNode(`${category.name}`);btn.appendChild(text);if(category.id==='knxy'){btn.classList.add('active')}container.appendChild(btn)})}let currentCategory='knxy';let folderHistory=[];function loadCategoryVideos(categoryId,isSubFolder=false){const listContainer=document.getElementById('videos-list');listContainer.innerHTML='';listContainer.style.animation='none';listContainer.offsetHeight;listContainer.style.animation='fadeInScale 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275)';if(!isSubFolder){currentCategory=categoryId;folderHistory=[]}if(!videoData[categoryId]||videoData[categoryId].length===0){listContainer.innerHTML=`<div class="no-videos"><svg class="svg-icon"><use href="#icon-video-slash"></use></svg><div>此分类下暂无视频内容</div></div>`;return}if(folderHistory.length>0){const backItem=document.createElement('div');backItem.className='video-item folder-item back-folder';backItem.innerHTML=`<div class="thumbnail"><img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='220' height='124' viewBox='0 0 220 124'%3E%3Crect width='220' height='124' fill='%231a1a2e'/%3E%3C/svg%3E"data-src="./img/back.jpg"alt="返回上一级"class="lazyload"><div class="folder-icon"><svg class="svg-icon"><use href="#icon-arrow-left"></use></svg></div></div><div class="video-title">返回上一级</div>`;listContainer.appendChild(backItem)}videoData[categoryId].forEach((video,index)=>{const item=document.createElement('div');if(video.isFolder){item.className='video-item folder-item';item.dataset.id=video.id;item.dataset.folderId=video.folderId;item.dataset.thumb=video.thumb;item.innerHTML=`<div class="thumbnail"><img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='220' height='124' viewBox='0 0 220 124'%3E%3Crect width='220' height='124' fill='%231a1a2e'/%3E%3C/svg%3E"data-src="${video.thumb}"alt="${video.title}"class="lazyload"><div class="folder-icon"><svg class="svg-icon"><use href="#icon-folder-open"></use></svg></div></div><div class="video-title">${video.title}</div>`}else{item.className='video-item';item.dataset.id=video.id;item.dataset.url=video.url;item.dataset.thumb=video.thumb;item.innerHTML=`<div class="thumbnail"><img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='220' height='124' viewBox='0 0 220 124'%3E%3Crect width='220' height='124' fill='%231a1a2e'/%3E%3C/svg%3E"data-src="${video.thumb}"alt="${video.title}"class="lazyload"><div class="play-icon"><svg class="svg-icon"><use href="#icon-play"></use></svg></div></div><div class="video-title">${video.title}</div>`}const delay=(index%12)*0.1+0.1;item.style.animationDelay=`${delay}s`;listContainer.appendChild(item)});initLazyLoad()}function initLazyLoad(){const lazyImages=document.querySelectorAll('img.lazyload');const observer=new IntersectionObserver((entries)=>{entries.forEach(entry=>{if(entry.isIntersecting){const img=entry.target;img.src=img.dataset.src;img.classList.remove('lazyload');observer.unobserve(img)}})},{rootMargin:'200px 0px'});lazyImages.forEach(img=>observer.observe(img))}function playVideo(url,thumb='',title='精彩视频'){if(!url){showCompatibilityAlert('此视频源不可用，请选择其他视频');return}if(currentVideoUrl===url){dp.play();return}currentVideoUrl=url;const loadTimeout=setTimeout(()=>{showCompatibilityAlert('视频加载时间较长，请耐心等待')},15000);try{const player=initDPlayer();if(player&&player.video){player.destroy();dp=null}const isIOSMain=/iPad|iPhone|iPod/.test(navigator.userAgent)||(navigator.platform==='MacIntel'&&navigator.maxTouchPoints>1);const isMP4=url.toLowerCase().endsWith('.mp4');if(isIOSMain){if(!isMP4&&Hls.isSupported()){const hls=new Hls({enableWorker:false,maxBufferLength:30,lowLatencyMode:false});hls.loadSource(url);hls.attachMedia(document.createElement('video'));hls.on(Hls.Events.MANIFEST_PARSED,()=>{clearTimeout(loadTimeout);const isIOSPlayer=/iPad|iPhone|iPod/.test(navigator.userAgent)&&!window.MSStream;dp=new DPlayer({container:document.getElementById('dplayer-container'),contextmenu:[],video:{url:url,pic:thumb,type:'customHls',customType:{'customHls':function(video,player){hls.attachMedia(video)}}},autoplay:true,autoHide:true,hideControlsAfter:3000});disableVideoContextMenu();dp.on('play',function(){setTimeout(function(){document.getElementById('dplayer-container').classList.add('dplayer-hide-controller');const isIOSPlayback=/iPad|iPhone|iPod/.test(navigator.userAgent)&&!window.MSStream;if(isIOSPlayback){const dplayerVideo=document.querySelector('.dplayer-video-current');if(dplayerVideo){setupIOSAutoHide(dplayerVideo)}}},1000)})});hls.on(Hls.Events.ERROR,(event,data)=>{console.error('HLS 错误:',data);clearTimeout(loadTimeout)});return}else{clearTimeout(loadTimeout);const isIOSNative=/iPad|iPhone|iPod/.test(navigator.userAgent)&&!window.MSStream;dp=new DPlayer({container:document.getElementById('dplayer-container'),contextmenu:[],video:{url:url,pic:thumb,type:'auto'},autoplay:true,autoHide:true,hideControlsAfter:3000});disableVideoContextMenu();dp.on('play',function(){setTimeout(function(){document.getElementById('dplayer-container').classList.add('dplayer-hide-controller');const isIOSControl=/iPad|iPhone|iPod/.test(navigator.userAgent)&&!window.MSStream;if(isIOSControl){const dplayerVideo=document.querySelector('.dplayer-video-current');if(dplayerVideo){setupIOSAutoHide(dplayerVideo)}}},1000)});return}}const isIOSDevice=/iPad|iPhone|iPod/.test(navigator.userAgent)&&!window.MSStream;dp=new DPlayer({container:document.getElementById('dplayer-container'),contextmenu:[],video:{url:url,pic:thumb,type:(url.toLowerCase().endsWith('.m3u8')||url.toLowerCase().endsWith('.js'))?'hls':'auto'},hls:{liveSyncDurationCount:3,maxMaxBufferLength:30,enableWorker:true},autoHide:true,hideControlsAfter:isIOSDevice?3000:3000,errorHandler:function(error){console.error('播放错误:',error);showCompatibilityAlert('视频播放失败，请重试');clearTimeout(loadTimeout)}});let durationStabilized=false;let lastDuration=0;disableVideoContextMenu();dp.on('canplay',function(){clearTimeout(loadTimeout);document.getElementById('compatibility-alert').style.display='none';setTimeout(()=>{dp.controller.hide();const isIOSCanPlay=/iPad|iPhone|iPod/.test(navigator.userAgent)&&!window.MSStream;if(isIOSCanPlay){const dplayerVideo=document.querySelector('.dplayer-video-current');if(dplayerVideo){setupIOSAutoHide(dplayerVideo)}}},100);if(!durationStabilized){const initialDuration=dp.video.duration;lastDuration=initialDuration;const durationCheck=setInterval(()=>{if(dp.video.duration!==lastDuration){lastDuration=dp.video.duration}else{updateDurationDisplay(lastDuration);durationStabilized=true;clearInterval(durationCheck)}},500)}});dp.on('error',function(){clearTimeout(loadTimeout)});dp.play();setupMobileControlsAutoHide()}catch(error){console.error('播放错误:',error);showCompatibilityAlert('视频播放失败: '+error.message);clearTimeout(loadTimeout)}}function setupMobileControlsAutoHide(){if(!dp||window.innerWidth>768)return;const dplayerContainer=document.getElementById('dplayer-container');let controlsHideTimer;const isIOSMobile=/iPad|iPhone|iPod/.test(navigator.userAgent)&&!window.MSStream;dplayerContainer.addEventListener('touchstart',function(){clearTimeout(controlsHideTimer);controlsHideTimer=setTimeout(()=>{if(dp&&!dp.video.paused){dp.controller.hide()}},3000)});if(isIOSMobile){const dplayerVideo=document.querySelector('.dplayer-video-current');if(dplayerVideo){dplayerVideo.addEventListener('click',function(){clearTimeout(controlsHideTimer);controlsHideTimer=setTimeout(()=>{if(dp&&!dp.video.paused){dp.controller.hide()}},3000)})}document.addEventListener('touchend',function(){if(dp&&!dp.video.paused){clearTimeout(controlsHideTimer);controlsHideTimer=setTimeout(()=>{dp.controller.hide()},3000)}})}}function showCompatibilityAlert(message){const alert=document.getElementById('compatibility-alert');const messageElement=document.getElementById('compatibility-message');messageElement.textContent=message;alert.style.display='flex';setTimeout(()=>{alert.style.display='none'},3000)}function setupIOSAutoHide(videoElement){if(!dp||!videoElement)return;let iosControlsHideTimer;videoElement.addEventListener('click',function(){clearTimeout(iosControlsHideTimer);iosControlsHideTimer=setTimeout(()=>{if(dp&&!dp.video.paused){dp.controller.hide()}},3000)});const observer=new MutationObserver(function(mutations){mutations.forEach(function(mutation){if(mutation.attributeName==='class'){clearTimeout(iosControlsHideTimer);iosControlsHideTimer=setTimeout(()=>{if(dp&&!dp.video.paused){dp.controller.hide()}},3000)}})});observer.observe(document.querySelector('.dplayer'),{attributes:true})}function detectCompatibility(){const video=document.createElement('video');if(!video.canPlayType('application/vnd.apple.mpegurl')&&!Hls.isSupported()){showCompatibilityAlert('您的设备可能需要JavaScript兼容模式播放视频')}}function initAppUI(){initDPlayer();initCategories();setTimeout(()=>{loadCategoryVideos('knxy')},100);detectCompatibility();document.getElementById('categories-container').addEventListener('click',(e)=>{const btn=e.target.closest('.category-btn');if(btn){document.querySelectorAll('.category-btn.active').forEach(e=>e.classList.remove('active'));btn.classList.add('active');loadCategoryVideos(btn.dataset.category)}});document.getElementById('videos-list').addEventListener('click',(e)=>{const item=e.target.closest('.video-item');if(!item)return;if(item.classList.contains('back-folder')){if(folderHistory.length>0){const prevFolder=folderHistory.pop();loadCategoryVideos(prevFolder,true)}else{loadCategoryVideos(currentCategory)}return}if(item.classList.contains('folder-item')){const folderId=item.dataset.folderId;if(folderId&&videoData[folderId]){folderHistory.push(currentCategory);loadCategoryVideos(folderId,true)}return}const url=item.dataset.url;const thumb=item.querySelector('img').dataset.src;playVideo(url,thumb,item.querySelector('.video-title').textContent)});const commentsToggleBtn=document.getElementById('comments-toggle-btn');const walineContainer=document.getElementById('waline');if(commentsToggleBtn&&walineContainer){walineContainer.classList.add('show');const textNode=commentsToggleBtn.childNodes[2];textNode.textContent=' 收起留言板 ';commentsToggleBtn.classList.add('active');commentsToggleBtn.addEventListener('click',function(){const isHidden=!walineContainer.classList.contains('show');const textNode=commentsToggleBtn.childNodes[2];if(isHidden){walineContainer.classList.add('show');textNode.textContent=' 收起留言板 ';commentsToggleBtn.classList.add('active');if(!window.walineInitialized){window.walineInitialized=true}}else{walineContainer.classList.remove('show');textNode.textContent=' 展开留言板 ';commentsToggleBtn.classList.remove('active')}})}const backToTopBtn=document.getElementById('back-to-top');if(backToTopBtn){window.addEventListener('scroll',function(){if(window.scrollY>300){backToTopBtn.classList.add('visible')}else{backToTopBtn.classList.remove('visible')}});backToTopBtn.addEventListener('click',function(){window.scrollTo({top:0,behavior:'smooth'})});backToTopBtn.addEventListener('keydown',function(e){if(e.key==='Enter'||e.key===' '){e.preventDefault();window.scrollTo({top:0,behavior:'smooth'})}})}}initAppUI()}function updateDurationDisplay(duration){}function formatTime(seconds){if(isNaN(seconds))return'00:00';const minutes=Math.floor(seconds/60);const remainingSeconds=Math.floor(seconds%60);return`${minutes.toString().padStart(2,'0')}:${remainingSeconds.toString().padStart(2,'0')}`}
