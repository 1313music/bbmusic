function initializeApp(){disableVideoContextMenu();const videoData=window.videoData||{},categories=window.categories||[];let dp=null,currentVideoUrl="";function initDPlayer(){return dp||(dp=new DPlayer({container:document.getElementById("dplayer-container"),live:!1,autoplay:!1,theme:"#d4af37",loop:!1,lang:"zh-cn",hotkey:!0,volume:.7,playbackSpeed:[.5,.75,1,1.25,1.5,2],mutex:!0,contextmenu:[],video:{url:"",pic:"https://v.1701701.xyz/img/bg.jpg"},errorHandler:function(error){console.error("DPlayer error:",error),showCompatibilityAlert("视频播放失败: "+error.message)},mobileControls:!0,hideControlsAfter:1e3,autoHide:!0}),disableVideoContextMenu(),setTimeout(()=>{dp&&dp.controller&&dp.controller.hide()},1e3),dp)}function disableVideoContextMenu(){setTimeout(()=>{const dplayerContainer=document.getElementById("dplayer-container");dplayerContainer&&dplayerContainer.addEventListener("contextmenu",function(e){return e.preventDefault(),!1});document.querySelectorAll("video").forEach(video=>{video.addEventListener("contextmenu",function(e){return e.preventDefault(),!1}),video.addEventListener("dragstart",function(e){return e.preventDefault(),!1})}),document.addEventListener("contextmenu",function(e){if("VIDEO"===e.target.tagName)return e.preventDefault(),!1}),document.addEventListener("dragstart",function(e){if("VIDEO"===e.target.tagName)return e.preventDefault(),!1})},500)}let currentCategory="knxy",folderHistory=[];function loadCategoryVideos(categoryId,isSubFolder=!1){const listContainer=document.getElementById("videos-list");if(listContainer.innerHTML="",listContainer.style.animation="none",listContainer.offsetHeight,listContainer.style.animation="fadeInScale 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275)",isSubFolder||(currentCategory=categoryId,folderHistory=[]),videoData[categoryId]&&0!==videoData[categoryId].length){if(folderHistory.length>0){const backItem=document.createElement("div");backItem.className="video-item folder-item back-folder",backItem.innerHTML='\n                    <div class="thumbnail">\n                        <img src="data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'220\' height=\'124\' viewBox=\'0 0 220 124\'%3E%3Crect width=\'220\' height=\'124\' fill=\'%231a1a2e\'/%3E%3C/svg%3E" \n                             data-src="./img/back.jpg" \n                             alt="返回上一级" \n                             class="lazyload">\n                        <div class="folder-icon"><svg class="svg-icon"><use href="#icon-arrow-left"></use></svg></div>\n                    </div>\n                    <div class="video-title">返回上一级</div>\n                ',listContainer.appendChild(backItem)}videoData[categoryId].forEach((video,index)=>{const item=document.createElement("div");video.isFolder?(item.className="video-item folder-item",item.dataset.id=video.id,item.dataset.folderId=video.folderId,item.dataset.thumb=video.thumb,item.innerHTML=`\n                        <div class="thumbnail">\n                            <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='220' height='124' viewBox='0 0 220 124'%3E%3Crect width='220' height='124' fill='%231a1a2e'/%3E%3C/svg%3E" \n                                 data-src="${video.thumb}" \n                                 alt="${video.title}" \n                                 class="lazyload">\n                            <div class="folder-icon"><svg class="svg-icon"><use href="#icon-folder-open"></use></svg></div>\n                        </div>\n                        <div class="video-title">${video.title}</div>\n                    `):(item.className="video-item",item.dataset.id=video.id,item.dataset.url=video.url,item.dataset.thumb=video.thumb,item.innerHTML=`\n                        <div class="thumbnail">\n                            <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='220' height='124' viewBox='0 0 220 124'%3E%3Crect width='220' height='124' fill='%231a1a2e'/%3E%3C/svg%3E" \n                                 data-src="${video.thumb}" \n                                 alt="${video.title}" \n                                 class="lazyload">\n                            <div class="play-icon"><svg class="svg-icon"><use href="#icon-play"></use></svg></div>\n                        </div>\n                        <div class="video-title">${video.title}</div>\n                    `);const delay=index%12*.1+.1;item.style.animationDelay=`${delay}s`,listContainer.appendChild(item)}),function(){const lazyImages=document.querySelectorAll("img.lazyload"),observer=new IntersectionObserver(entries=>{entries.forEach(entry=>{if(entry.isIntersecting){const img=entry.target;img.src=img.dataset.src,img.classList.remove("lazyload"),observer.unobserve(img)}})},{rootMargin:"200px 0px"});lazyImages.forEach(img=>observer.observe(img))}()}else listContainer.innerHTML='\n                    <div class="no-videos">\n                        <svg class="svg-icon"><use href="#icon-video-slash"></use></svg>\n                        <div>此分类下暂无视频内容</div>\n                    </div>\n                '}function playVideo(url,thumb="",title="精彩视频"){if(!url)return void showCompatibilityAlert("此视频源不可用，请选择其他视频");if(currentVideoUrl===url)return void dp.play();currentVideoUrl=url;const loadTimeout=setTimeout(()=>{showCompatibilityAlert("视频加载时间较长，请耐心等待")},15e3);try{const player=initDPlayer();player&&player.video&&(player.destroy(),dp=null);const isIOSMain=/iPad|iPhone|iPod/.test(navigator.userAgent)||"MacIntel"===navigator.platform&&navigator.maxTouchPoints>1,isMP4=url.toLowerCase().endsWith(".mp4");if(isIOSMain){if(!isMP4&&Hls.isSupported()){const hls=new Hls({enableWorker:!1,maxBufferLength:30,lowLatencyMode:!1});return hls.loadSource(url),hls.attachMedia(document.createElement("video")),hls.on(Hls.Events.MANIFEST_PARSED,()=>{clearTimeout(loadTimeout);/iPad|iPhone|iPod/.test(navigator.userAgent)&&window.MSStream;dp=new DPlayer({container:document.getElementById("dplayer-container"),contextmenu:[],video:{url:url,pic:thumb,type:"customHls",customType:{customHls:function(video,player){hls.attachMedia(video)}}},autoplay:!0,autoHide:!0,hideControlsAfter:3e3}),disableVideoContextMenu(),dp.on("play",function(){setTimeout(function(){document.getElementById("dplayer-container").classList.add("dplayer-hide-controller");if(/iPad|iPhone|iPod/.test(navigator.userAgent)&&!window.MSStream){const dplayerVideo=document.querySelector(".dplayer-video-current");dplayerVideo&&setupIOSAutoHide(dplayerVideo)}},1e3)})}),void hls.on(Hls.Events.ERROR,(event,data)=>{console.error("HLS 错误:",data),clearTimeout(loadTimeout)})}clearTimeout(loadTimeout);/iPad|iPhone|iPod/.test(navigator.userAgent)&&window.MSStream;return dp=new DPlayer({container:document.getElementById("dplayer-container"),contextmenu:[],video:{url:url,pic:thumb,type:"auto"},autoplay:!0,autoHide:!0,hideControlsAfter:3e3}),disableVideoContextMenu(),void dp.on("play",function(){setTimeout(function(){document.getElementById("dplayer-container").classList.add("dplayer-hide-controller");if(/iPad|iPhone|iPod/.test(navigator.userAgent)&&!window.MSStream){const dplayerVideo=document.querySelector(".dplayer-video-current");dplayerVideo&&setupIOSAutoHide(dplayerVideo)}},1e3)})}/iPad|iPhone|iPod/.test(navigator.userAgent)&&window.MSStream;dp=new DPlayer({container:document.getElementById("dplayer-container"),contextmenu:[],video:{url:url,pic:thumb,type:url.toLowerCase().endsWith(".m3u8")||url.toLowerCase().endsWith(".js")?"hls":"auto"},hls:{liveSyncDurationCount:3,maxMaxBufferLength:30,enableWorker:!0},autoHide:!0,hideControlsAfter:3e3,errorHandler:function(error){console.error("播放错误:",error),showCompatibilityAlert("视频播放失败，请重试"),clearTimeout(loadTimeout)}});let durationStabilized=!1,lastDuration=0;disableVideoContextMenu(),dp.on("canplay",function(){if(clearTimeout(loadTimeout),document.getElementById("compatibility-alert").style.display="none",setTimeout(()=>{dp.controller.hide();if(/iPad|iPhone|iPod/.test(navigator.userAgent)&&!window.MSStream){const dplayerVideo=document.querySelector(".dplayer-video-current");dplayerVideo&&setupIOSAutoHide(dplayerVideo)}},100),!durationStabilized){const initialDuration=dp.video.duration;lastDuration=initialDuration;const durationCheck=setInterval(()=>{dp.video.duration!==lastDuration?lastDuration=dp.video.duration:(updateDurationDisplay(lastDuration),durationStabilized=!0,clearInterval(durationCheck))},500)}}),dp.on("error",function(){clearTimeout(loadTimeout)}),dp.play(),function(){if(!dp||window.innerWidth>768)return;const dplayerContainer=document.getElementById("dplayer-container");let controlsHideTimer;const isIOSMobile=/iPad|iPhone|iPod/.test(navigator.userAgent)&&!window.MSStream;if(dplayerContainer.addEventListener("touchstart",function(){clearTimeout(controlsHideTimer),controlsHideTimer=setTimeout(()=>{dp&&!dp.video.paused&&dp.controller.hide()},3e3)}),isIOSMobile){const dplayerVideo=document.querySelector(".dplayer-video-current");dplayerVideo&&dplayerVideo.addEventListener("click",function(){clearTimeout(controlsHideTimer),controlsHideTimer=setTimeout(()=>{dp&&!dp.video.paused&&dp.controller.hide()},3e3)}),document.addEventListener("touchend",function(){dp&&!dp.video.paused&&(clearTimeout(controlsHideTimer),controlsHideTimer=setTimeout(()=>{dp.controller.hide()},3e3))})}}()}catch(error){console.error("播放错误:",error),showCompatibilityAlert("视频播放失败: "+error.message),clearTimeout(loadTimeout)}}function showCompatibilityAlert(message){const alert=document.getElementById("compatibility-alert");document.getElementById("compatibility-message").textContent=message,alert.style.display="flex",setTimeout(()=>{alert.style.display="none"},3e3)}function setupIOSAutoHide(videoElement){if(!dp||!videoElement)return;let iosControlsHideTimer;videoElement.addEventListener("click",function(){clearTimeout(iosControlsHideTimer),iosControlsHideTimer=setTimeout(()=>{dp&&!dp.video.paused&&dp.controller.hide()},3e3)});new MutationObserver(function(mutations){mutations.forEach(function(mutation){"class"===mutation.attributeName&&(clearTimeout(iosControlsHideTimer),iosControlsHideTimer=setTimeout(()=>{dp&&!dp.video.paused&&dp.controller.hide()},3e3))})}).observe(document.querySelector(".dplayer"),{attributes:!0})}!function(){initDPlayer(),function(){const container=document.getElementById("categories-container");container.innerHTML="",categories.forEach(category=>{const btn=document.createElement("button");btn.className="category-btn",btn.dataset.category=category.id;const svgIcon=document.createElementNS("http://www.w3.org/2000/svg","svg");svgIcon.setAttribute("class","svg-icon"),svgIcon.setAttribute("viewBox","0 0 24 24");const useElement=document.createElementNS("http://www.w3.org/2000/svg","use");useElement.setAttributeNS("http://www.w3.org/1999/xlink","href",category.icon),svgIcon.appendChild(useElement),btn.appendChild(svgIcon);const text=document.createTextNode(` ${category.name}`);btn.appendChild(text),"knxy"===category.id&&btn.classList.add("active"),container.appendChild(btn)})}(),setTimeout(()=>{loadCategoryVideos("knxy")},100),document.createElement("video").canPlayType("application/vnd.apple.mpegurl")||Hls.isSupported()||showCompatibilityAlert("您的设备可能需要JavaScript兼容模式播放视频"),document.getElementById("categories-container").addEventListener("click",e=>{const btn=e.target.closest(".category-btn");btn&&(document.querySelectorAll(".category-btn.active").forEach(e=>e.classList.remove("active")),btn.classList.add("active"),loadCategoryVideos(btn.dataset.category))}),document.getElementById("videos-list").addEventListener("click",e=>{const item=e.target.closest(".video-item");if(!item)return;if(item.classList.contains("back-folder")){if(folderHistory.length>0){loadCategoryVideos(folderHistory.pop(),!0)}else loadCategoryVideos(currentCategory);return}if(item.classList.contains("folder-item")){const folderId=item.dataset.folderId;return void(folderId&&videoData[folderId]&&(folderHistory.push(currentCategory),loadCategoryVideos(folderId,!0)))}playVideo(item.dataset.url,item.querySelector("img").dataset.src,item.querySelector(".video-title").textContent)});const commentsToggleBtn=document.getElementById("comments-toggle-btn"),walineContainer=document.getElementById("waline");if(commentsToggleBtn&&walineContainer){walineContainer.classList.add("show");commentsToggleBtn.childNodes[2].textContent=" 收起留言板 ",commentsToggleBtn.classList.add("active"),commentsToggleBtn.addEventListener("click",function(){const isHidden=!walineContainer.classList.contains("show"),textNode=commentsToggleBtn.childNodes[2];isHidden?(walineContainer.classList.add("show"),textNode.textContent=" 收起留言板 ",commentsToggleBtn.classList.add("active"),window.walineInitialized||(window.walineInitialized=!0)):(walineContainer.classList.remove("show"),textNode.textContent=" 展开留言板 ",commentsToggleBtn.classList.remove("active"))})}const backToTopBtn=document.getElementById("back-to-top");backToTopBtn&&(window.addEventListener("scroll",function(){window.scrollY>300?backToTopBtn.classList.add("visible"):backToTopBtn.classList.remove("visible")}),backToTopBtn.addEventListener("click",function(){window.scrollTo({top:0,behavior:"smooth"})}),backToTopBtn.addEventListener("keydown",function(e){"Enter"!==e.key&&" "!==e.key||(e.preventDefault(),window.scrollTo({top:0,behavior:"smooth"}))}))}()}function updateDurationDisplay(duration){}function formatTime(seconds){if(isNaN(seconds))return"00:00";const minutes=Math.floor(seconds/60),remainingSeconds=Math.floor(seconds%60);return`${minutes.toString().padStart(2,"0")}:${remainingSeconds.toString().padStart(2,"0")}`}window.addEventListener("DOMContentLoaded",function(){function loadScript(src,callback){const script=document.createElement("script");script.src=src,script.defer=!0,script.onload=callback,document.body.appendChild(script)}loadScript("js/videoData.js?t=2025100101",function(){loadScript("lib/hls.min.js",function(){Hls.isSupported()&&(Hls.DefaultConfig.enableWorker=!0,Hls.DefaultConfig.enableStreaming=!0,Hls.DefaultConfig.maxBufferLength=30,Hls.DefaultConfig.maxMaxBufferLength=60,Hls.DefaultConfig.liveSyncDurationCount=3),loadScript("lib/DPlayer.min.js",initializeApp)})})});
